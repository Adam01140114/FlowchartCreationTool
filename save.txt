HOW PREFILL FEATURE IS PRESERVED IN SAVING PROCESSES
====================================================

This document explains how the prefill input field for multiple textbox questions
is preserved across all saving mechanisms in the Flowchart Creation Tool.

1. DATA STRUCTURE
-----------------
The prefill value is stored as a property within each textbox object in the 
cell._textboxes array:

  cell._textboxes[index] = {
    nameId: "textbox_name",
    placeholder: "Enter value",
    isAmountOption: false,
    prefill: "default_value"  // <-- Prefill property
  }

2. INITIALIZATION
-----------------
The prefill property is initialized in multiple places to ensure it always exists:

a) When creating a new multiple textbox question:
   Location: questions.js, line 419
   Code: cell._textboxes = [{ nameId:'', placeholder:'Enter value', prefill: '' }];

b) When rendering textboxes (if array doesn't exist):
   Location: questions.js, line 572
   Code: cell._textboxes = [{ nameId: "", placeholder: "Enter value", isAmountOption: false, prefill: '' }];

c) When adding a new textbox via "Add Option" button:
   Location: questions.js, line 13004 and 13007
   Code: cell._textboxes.push({ nameId: "", placeholder: "Enter value", isAmountOption: false, prefill: '' });

d) When adding a new textbox via "+ Add Textbox" button in properties menu:
   Location: questions.js, line 11738
   Code: const newTextbox = { nameId: '', placeholder: 'Enter value', isAmountOption: false, prefill: '' };

e) In the createTextboxField function (if property doesn't exist):
   Location: questions.js, line 12228-12230
   Code:
     if (textbox.prefill === undefined) {
       textbox.prefill = '';
     }

3. USER INPUT HANDLING
----------------------
When the user types in the prefill input field:

Location: questions.js, line 12220-12225
Code:
  prefillInput.onblur = () => {
    textbox.prefill = prefillInput.value.trim();
    if (typeof window.requestAutosave === 'function') {
      window.requestAutosave();
    }
  };

This ensures:
- The value is saved to the textbox object immediately when the field loses focus
- Autosave is triggered to persist the change

4. AUTOSAVE PROCESS
------------------
The autosave mechanism automatically saves all cell properties, including _textboxes:

Location: script.js, autosaveFlowchartToLocalStorage function

How it works:
1. The autosave function exports the entire flowchart using exportFlowchartJson()
2. exportFlowchartJson() includes all _textboxes with their properties
3. The prefill property is included because it's part of the textbox object
4. The data is saved to localStorage with a timestamp

The prefill value is preserved because:
- It's a property of the textbox object
- The entire _textboxes array is serialized to JSON
- JSON.stringify() includes all enumerable properties, including prefill

5. FLOWCHART JSON EXPORT/IMPORT
--------------------------------
The exportFlowchartJson function in library.js and url.js exports all cell properties:

Location: library.js and url.js, exportFlowchartJson function

How it works:
1. The function iterates through all cells in the graph
2. For each cell, it creates a cellData object with all properties
3. The _textboxes array is included with all its properties:
   - nameId
   - placeholder
   - isAmountOption
   - prefill  // <-- Automatically included

4. The entire flowchart is serialized to JSON
5. When importing, loadFlowchartData() restores all properties including prefill

The prefill is preserved because:
- The _textboxes array is part of the cell's properties
- All properties starting with "_" are included in the export
- The import process restores the entire _textboxes array structure

6. FIRESTORE LIBRARY SAVE
--------------------------
When saving to Firestore library:

Location: library.js, exportFlowchartJson function (used by Firestore save)

How it works:
1. The same exportFlowchartJson function is used for Firestore saves
2. The flowchart JSON is uploaded to Firestore
3. When loading from Firestore, the same import process restores prefill values

The prefill is preserved because:
- It uses the same export/import mechanism as regular flowchart saves
- The _textboxes array structure is maintained in Firestore
- All textbox properties are preserved during the round-trip

7. CODE LOCATIONS SUMMARY
-------------------------
Key files and functions:

questions.js:
  - Line 419: Initialization in setQuestionType
  - Line 572: Initialization in renderTextboxes
  - Line 11738: Initialization when adding textbox via properties menu
  - Line 12054-12249: createTextboxField function (UI creation and value saving)
  - Line 12220-12225: onblur handler that saves prefill value
  - Line 12228-12230: Safety check to initialize prefill if undefined
  - Line 13004, 13007: Initialization in addMultipleTextboxHandler

library.js:
  - exportFlowchartJson: Exports all cell properties including _textboxes
  - loadFlowchartData: Imports and restores all cell properties

script.js:
  - autosaveFlowchartToLocalStorage: Saves flowchart to localStorage
  - Uses exportFlowchartJson which includes prefill

url.js:
  - exportFlowchartJson: Alternative export function (same mechanism)

8. TESTING THE PERSISTENCE
--------------------------
To verify prefill is preserved:

1. Create a multiple textbox question
2. Add a textbox entry
3. Enter a prefill value (e.g., "test123")
4. Close the properties menu
5. Export the flowchart JSON
6. Check the JSON - the prefill value should be in _textboxes[0].prefill
7. Import the flowchart JSON
8. Open the properties menu - the prefill value should still be "test123"
9. Test autosave by closing the browser and reopening
10. Test Firestore save by saving to library and loading back

9. WHY IT WORKS AUTOMATICALLY
-----------------------------
The prefill feature is preserved automatically because:

1. It's stored as a property of the textbox object
2. The _textboxes array is part of the cell's data structure
3. All cell properties (including those starting with "_") are:
   - Included in JSON export
   - Saved to localStorage (autosave)
   - Uploaded to Firestore
   - Restored on import/load

4. No special handling is needed because:
   - JSON.stringify() automatically includes all object properties
   - The import process restores the entire object structure
   - The UI reads from the same data structure

10. BEST PRACTICES
-----------------
To ensure prefill (or any new property) is preserved:

1. Always initialize the property when creating new objects:
   { nameId: '', placeholder: '', prefill: '' }

2. Initialize in all creation paths:
   - setQuestionType
   - renderTextboxes (fallback)
   - addMultipleTextboxHandler
   - Properties menu "Add" buttons

3. Add a safety check in the UI creation function:
   if (textbox.prefill === undefined) {
     textbox.prefill = '';
   }

4. Save the value immediately on user input:
   input.onblur = () => {
     textbox.prefill = input.value.trim();
     requestAutosave();
   };

5. No special export/import code needed - it's automatic!

