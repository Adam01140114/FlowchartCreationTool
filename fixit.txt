FLOWCHART TOOL - FIXIT DOCUMENTATION
=====================================

INCIDENT: Dropdown Layout Inconsistency in Properties Popup
DATE: [Current Date]
ISSUE ID: DROPDOWN_LAYOUT_001

PROBLEM DESCRIPTION:
===================
The Section Name dropdown in the Node Properties popup was not displaying with the same layout as other dropdowns (specifically the Node Type dropdown). The Section Name dropdown was appearing above its label instead of to the right of it, creating visual inconsistency.

WHAT WE WERE ATTEMPTING TO DO:
=============================
- Make the Section Name dropdown use the same horizontal layout as the Node Type dropdown
- Ensure consistent visual appearance across all dropdown fields in the properties popup
- Have the label appear on the left and the dropdown on the right, side by side

ISSUES ENCOUNTERED:
==================
1. INITIAL ATTEMPT - Vertical Layout:
   - Changed the Section Name dropdown to use `flex-direction: column`
   - This put the label above the dropdown, but user wanted horizontal layout like Node Type

2. SECOND ATTEMPT - CSS Override:
   - Tried to override the fieldDiv styling for dropdowns
   - Still resulted in vertical layout instead of horizontal

3. ROOT CAUSE DISCOVERY:
   - The Node Type dropdown uses `isQuestionTypeDropdown: true` which gets special handling
   - The Section Name dropdown was using `isDropdown: true` which goes through different code path
   - The `isDropdown` code path was designed for vertical layout, not horizontal

TECHNICAL DETAILS:
==================
- File: graph.js
- Node Type dropdown: Uses `isQuestionTypeDropdown: true` → special handling around line 910
- Section Name dropdown: Was using `isDropdown: true` → different handling around line 1005
- The `isDropdown` path was creating vertical layout with `flex-direction: column`
- The `isQuestionTypeDropdown` path uses standard horizontal layout

SOLUTION THAT WORKED:
====================
1. Changed Section Name field property from `isDropdown: true` to `isSectionNameDropdown: true`
2. Added new special handling for `isSectionNameDropdown` that mirrors the `isQuestionTypeDropdown` handling
3. Used the exact same layout code: `fieldDiv.appendChild(label)` then `fieldDiv.appendChild(dropdown)`
4. Applied the same CSS styling as the Node Type dropdown

CODE CHANGES:
=============
1. In properties array definition (around line 760):
   - Changed: `isDropdown: true`
   - To: `isSectionNameDropdown: true`

2. Added new handling section (around line 986):
   ```javascript
   // Special handling for section name dropdown
   if (prop.isSectionNameDropdown) {
     const dropdown = document.createElement('select');
     dropdown.id = prop.id;
     dropdown.style.cssText = `
       flex: 1;
       padding: 8px 12px;
       border: 1px solid #ddd;
       border-radius: 6px;
       background: white;
       color: #333;
       font-size: 14px;
       cursor: pointer;
       transition: all 0.2s ease;
     `;
     
     // Add options, set value, add change listener...
     
     fieldDiv.appendChild(label);
     fieldDiv.appendChild(dropdown);
     content.appendChild(fieldDiv);
     return; // Skip the normal field creation
   }
   ```

KEY LEARNINGS:
==============
1. When trying to make UI elements look the same, check if they're using different code paths
2. Look for existing working examples (Node Type dropdown) and replicate their approach
3. Don't try to override CSS when the issue is in the JavaScript logic
4. Create new property types (`isSectionNameDropdown`) rather than trying to modify existing ones
5. Always use the same layout pattern: `fieldDiv.appendChild(label)` then `fieldDiv.appendChild(dropdown)`

PREVENTION:
===========
- When adding new dropdown fields, use the same pattern as existing working dropdowns
- If a dropdown needs horizontal layout, use `isQuestionTypeDropdown` or create a similar property
- If a dropdown needs vertical layout, use `isDropdown`
- Always test new dropdowns against existing ones to ensure visual consistency

RELATED FILES:
=============
- graph.js (main file with properties popup logic)
- style.css (general styling, but not the issue in this case)

FUTURE REFERENCE:
================
If you encounter similar dropdown layout issues:
1. Check what property type the working dropdown uses (`isQuestionTypeDropdown`)
2. Check what property type the broken dropdown uses (`isDropdown`)
3. Either change the property type or create a new one that mirrors the working approach
4. Use the same layout code pattern: label first, then dropdown, both appended to fieldDiv

=====================================

INCIDENT: Context Menu Node Creation Issues
DATE: [Current Date]
ISSUE ID: CONTEXT_MENU_CREATION_001

PROBLEM DESCRIPTION:
===================
1. Question nodes created via right-click context menu were not showing the "Choose Question Type" dropdown
2. Calculation nodes created via right-click context menu were throwing "graph.getModel is not a function" error
3. Context menu node creation was inconsistent with drag-and-drop node creation

WHAT WE WERE ATTEMPTING TO DO:
=============================
- Make right-click context menu create nodes with the same functionality as drag-and-drop
- Ensure question nodes from context menu show the dropdown for selecting question type
- Fix JavaScript errors when creating calculation nodes from context menu

ISSUES ENCOUNTERED:
==================
1. GRAPH REFERENCE ERROR:
   - Context menu function `placeNodeAtClickLocation(graph, nodeType)` was trying to use `graph.getModel()`
   - The `graph` parameter wasn't properly available, causing "graph.getModel is not a function" error

2. INCONSISTENT NODE CREATION:
   - Drag-and-drop created nodes with label "question node" which triggered dropdown in `refreshAllCells()`
   - Context menu created nodes with empty label, so `refreshAllCells()` didn't detect them as needing dropdown
   - Different initialization logic between drag-and-drop and context menu

3. MISSING CALCULATION NODE SUPPORT:
   - Context menu was missing the calculation node handler
   - `placeCalcNode` element wasn't properly referenced in context menu setup

TECHNICAL DETAILS:
==================
- File: context-menus.js
- Drag-and-drop logic: Uses `mxUtils.makeDraggable` with callback that gets `graph` parameter
- Context menu logic: Was trying to use `graph` parameter that wasn't always available
- `refreshAllCells()` function checks for placeholder text "question node" to show dropdown
- Context menu was creating nodes with empty labels instead of "question node"

SOLUTION THAT WORKED:
====================
1. FIXED GRAPH REFERENCE ERROR:
   ```javascript
   // Use the global graph variable if the parameter is not available
   const graphToUse = graph || window.graph;
   if (!graphToUse) {
     console.error('Graph not available for node placement');
     return;
   }
   ```

2. LINKED CONTEXT MENU TO DRAG-AND-DROP LOGIC:
   - Made context menu use same style as drag-and-drop elements
   - Made context menu use same initialization logic as drag-and-drop
   - Made context menu use same finalization logic as drag-and-drop

3. ADDED MISSING CALCULATION NODE SUPPORT:
   - Added `placeCalcNode` variable declaration
   - Added `placeCalcNode` element initialization
   - Added calculation node event handler

CODE CHANGES:
=============
1. Fixed graph reference in `placeNodeAtClickLocation` function:
   ```javascript
   const graphToUse = graph || window.graph;
   // Use graphToUse instead of graph throughout the function
   ```

2. Made context menu use same style as drag-and-drop:
   ```javascript
   if (nodeType === 'question') {
     // Use the same style as the drag-and-drop elements
     const toolbarShape = document.querySelector('.shape[data-type="question"]');
     if (toolbarShape) {
       style = toolbarShape.dataset.style;
       if (!style.includes("pointerEvents=")) {
         style += "pointerEvents=1;overflow=fill;";
       }
     }
     label = "question node"; // Set placeholder label to trigger dropdown
   }
   ```

3. Added same initialization logic as drag-and-drop:
   ```javascript
   if (nodeType === 'question') {
     if (typeof window.isQuestion === 'function' && window.isQuestion(cell)) {
       if (typeof window.getQuestionType === 'function') {
         const qType = window.getQuestionType(cell);
         if (qType && typeof window.setQuestionType === 'function') {
           window.setQuestionType(cell, qType);
         }
       }
     }
   }
   ```

4. Added calculation node support:
   ```javascript
   // Variable declaration
   let placeCalcNode, placeNotesNode, placeChecklistNode, ...
   
   // Element initialization
   placeCalcNode = document.getElementById('placeCalcNode');
   
   // Event handler
   if (placeCalcNode) {
     placeCalcNode.addEventListener('click', function() {
       placeNodeAtClickLocation(graph, 'calculation');
       hideContextMenu();
     });
   }
   ```

KEY LEARNINGS:
==============
1. When context menu and drag-and-drop behave differently, check if they're using different code paths
2. Always use the global `window.graph` as fallback when graph parameter might not be available
3. Make context menu use the exact same logic as drag-and-drop for consistency
4. Check for missing element references and event handlers when adding new functionality
5. Use placeholder text that `refreshAllCells()` can detect to trigger proper initialization

PREVENTION:
===========
- Always link context menu functionality to the same functions as drag-and-drop
- Use fallback graph reference to prevent "graph.getModel is not a function" errors
- Ensure all node types have proper event handlers in context menu setup
- Test context menu creation against drag-and-drop creation to ensure consistency

RELATED FILES:
=============
- context-menus.js (main file with context menu logic)
- events.js (drag-and-drop logic to replicate)
- script.js (refreshAllCells function that handles dropdown display)

FUTURE REFERENCE:
================
If you encounter similar context menu issues:
1. Check if context menu is using the same logic as drag-and-drop
2. Use `const graphToUse = graph || window.graph;` to prevent graph reference errors
3. Make context menu read styles from drag-and-drop elements for consistency
4. Ensure all node types have proper event handlers in context menu setup
5. Use placeholder text that triggers proper initialization in `refreshAllCells()`

=====================================

INCIDENT: Calculation Node Properties Menu Migration
DATE: [Current Date]
ISSUE ID: CALC_PROPERTIES_MIGRATION_001

PROBLEM DESCRIPTION:
===================
The calculation node had complex inline editing functionality that was difficult to maintain and use. The node displayed multiple dropdowns, input fields, and conditional content directly on the canvas, making it cluttered and hard to configure. Users needed a cleaner, more organized way to configure calculation node properties.

WHAT WE WERE ATTEMPTING TO DO:
=============================
- Move all calculation node configuration from inline canvas editing to a dedicated properties popup
- Create a comprehensive properties menu that appears when double-clicking a calculation node
- Simplify the on-canvas display to show only essential information
- Make the configuration process more user-friendly and organized

ISSUES ENCOUNTERED:
==================
1. COMPLEX INLINE UI:
   - Calculation nodes had multiple dropdowns, input fields, and conditional content on the canvas
   - The UI was cluttered and difficult to use
   - Conditional display logic was complex and hard to maintain

2. DOUBLE-CLICK HANDLER CONFLICTS:
   - Multiple double-click handlers were conflicting with each other
   - One handler was calling the wrong function name (`showCalculationProperties` instead of `showCalculationNodeProperties`)
   - The correct handler was being overridden by an incorrect one

3. PROPERTIES POPUP COMPLEXITY:
   - Needed to create a comprehensive popup with multiple field types
   - Had to handle dynamic content (calculation terms, conditional fields)
   - Required proper event handling for all field types

TECHNICAL DETAILS:
==================
- File: calc.js (main calculation node logic)
- File: events.js (double-click handlers)
- File: graph.js (conflicting double-click handler)
- The inline UI was generated in `updateCalculationNodeCell()` function
- Properties popup was created in `showCalculationNodeProperties()` function

SOLUTION THAT WORKED:
====================
1. SIMPLIFIED ON-CANVAS DISPLAY:
   ```javascript
   // Replaced complex inline form with simple display
   const html = `
     <div style="padding: 20px; font-family: Arial, sans-serif;">
       <div style="font-weight: bold; color: #2196F3; margin-bottom: 10px;">${cell._calcTitle}</div>
       <div style="margin-bottom: 8px;"><strong>Calculation:</strong> ${displayCalculation}</div>
       <div style="margin-bottom: 8px;"><strong>Condition:</strong> ${displayCondition}</div>
       <div style="margin-bottom: 8px;"><strong>Output:</strong> ${displayOutput}</div>
       <div style="font-style: italic; color: #666; font-size: 12px; margin-top: 15px;">Double-click to configure</div>
     </div>
   `;
   ```

2. CREATED COMPREHENSIVE PROPERTIES POPUP:
   ```javascript
   window.showCalculationNodeProperties = function(cell) {
     // Create modal popup with all configuration options
     const modal = document.createElement('div');
     modal.className = 'calc-properties-modal';
     
     // Add all necessary fields:
     // - Title input
     // - Calculation terms (dynamic)
     // - Comparison operator dropdown
     // - Threshold number input
     // - Final output type dropdown
     // - Conditional fields (text input or checkbox)
   };
   ```

3. FIXED DOUBLE-CLICK HANDLER CONFLICTS:
   ```javascript
   // In events.js - corrected function name
   if (typeof window.isCalculationNode === 'function' && window.isCalculationNode(cell)) {
     if (typeof window.showCalculationNodeProperties === 'function') {
       window.showCalculationNodeProperties(cell); // Fixed function name
     }
     mxEvent.consume(evt);
     return;
   }
   
   // In graph.js - removed conflicting handler
   // Removed the duplicate double-click handler that was calling wrong function
   ```

4. ADDED HELPER FUNCTIONS FOR POPUP:
   ```javascript
   // Helper functions for creating different field types
   function createField(label, input) { ... }
   function createDropdownField(label, options, value, onChange) { ... }
   function createCheckboxField(label, checked, onChange) { ... }
   function createCalculationTermsContainer(cell) { ... }
   function createCalculationTermField(term, index, cell) { ... }
   ```

CODE CHANGES:
=============
1. Simplified `updateCalculationNodeCell()` function:
   - Removed complex inline form HTML
   - Added simple display with essential information
   - Added "Double-click to configure" instruction

2. Created `showCalculationNodeProperties()` function:
   - Comprehensive modal popup with all configuration options
   - Dynamic calculation terms management
   - Conditional field display based on output type
   - Proper event handling for all field types

3. Fixed double-click handlers:
   - Corrected function name in events.js
   - Removed conflicting handler in graph.js

4. Added helper functions:
   - `createField()` - basic field creation
   - `createDropdownField()` - dropdown field creation
   - `createCheckboxField()` - checkbox field creation
   - `createCalculationTermsContainer()` - dynamic terms management
   - `createCalculationTermField()` - individual term field creation

KEY LEARNINGS:
==============
1. Complex inline UI should be moved to dedicated properties popups for better UX
2. Always check for conflicting event handlers when implementing new functionality
3. Use helper functions to reduce code duplication in complex UI creation
4. Provide clear visual cues (like "Double-click to configure") for user interaction
5. Simplify on-canvas display to show only essential information

PREVENTION:
===========
- When nodes have complex configuration, consider moving to properties popup
- Always check for existing event handlers before adding new ones
- Use consistent function naming to avoid conflicts
- Create helper functions for repeated UI patterns
- Test double-click functionality thoroughly when adding new node types

RELATED FILES:
=============
- calc.js (main calculation node logic and properties popup)
- events.js (double-click handlers)
- graph.js (removed conflicting handler)

FUTURE REFERENCE:
================
To replicate this process for other nodes:
1. Identify complex inline UI that should be moved to properties popup
2. Create comprehensive properties popup with all configuration options
3. Simplify on-canvas display to show only essential information
4. Add "Double-click to configure" instruction
5. Check for and resolve any conflicting event handlers
6. Create helper functions for repeated UI patterns
7. Test thoroughly to ensure all functionality works correctly

MIGRATION PROCESS FOR OTHER NODES:
==================================
1. **ANALYZE CURRENT UI**: Identify what configuration options are currently inline
2. **DESIGN POPUP STRUCTURE**: Plan the layout and organization of the properties popup
3. **CREATE POPUP FUNCTION**: Build the comprehensive properties popup
4. **SIMPLIFY CANVAS DISPLAY**: Replace complex inline UI with simple display
5. **ADD HELPER FUNCTIONS**: Create reusable functions for common UI patterns
6. **FIX EVENT HANDLERS**: Ensure double-click handlers work correctly
7. **TEST THOROUGHLY**: Verify all functionality works in the new popup
8. **ADD USER INSTRUCTIONS**: Include clear instructions for accessing configuration

=====================================

INCIDENT: Right-Click Menu Node Creation Issues for Special Node Types
DATE: [Current Date]
ISSUE ID: RIGHT_CLICK_SPECIAL_NODES_001

PROBLEM DESCRIPTION:
===================
1. Linked Logic nodes created via right-click context menu appeared as ugly, empty rectangles
2. Hidden Checkbox and Hidden Textbox nodes created via right-click context menu also appeared as basic rectangles
3. Double-clicking on these nodes created via right-click menu did nothing (no properties menu opened)
4. Right-click menu node creation was inconsistent with drag-and-drop node creation for special node types

WHAT WE WERE ATTEMPTING TO DO:
=============================
- Make right-click context menu create special node types (Linked Logic, Hidden Checkbox, Hidden Textbox) with the same appearance and functionality as drag-and-drop
- Ensure these nodes have proper styling, dimensions, and initialization
- Make double-click functionality work correctly on nodes created via right-click menu

ISSUES ENCOUNTERED:
==================
1. MISSING NODE TYPE CASES:
   - The `placeNodeAtClickLocation` function in context-menus.js was missing cases for `hiddenCheckbox`, `hiddenTextbox`, and `linkedLogic` node types
   - These node types were falling through to the default case, creating basic cells without proper styling

2. MISSING INITIALIZATION LOGIC:
   - Even when basic cells were created, they lacked the proper initialization logic
   - No default properties were being set (like `_hiddenNodeId`, `_linkedLogicNodeId`, etc.)
   - No update functions were being called to set up the proper display

3. INCONSISTENT STYLING:
   - Right-click created nodes had different styling than drag-and-drop created nodes
   - Missing proper colors, dimensions, and visual properties

TECHNICAL DETAILS:
==================
- File: context-menus.js
- Function: `placeNodeAtClickLocation(graph, nodeType)`
- The function had cases for standard node types but was missing special node types
- Drag-and-drop uses `createNode()` function in nodes.js which has proper initialization
- Right-click menu was creating basic `insertVertex()` calls without proper setup

SOLUTION THAT WORKED:
====================
1. ADDED MISSING NODE TYPE CASES:
   ```javascript
   } else if (nodeType === 'hiddenCheckbox') {
     style = "shape=roundRect;rounded=1;arcSize=20;whiteSpace=wrap;html=1;nodeType=hiddenCheckbox;section=1;strokeWidth=3;strokeColor=#0066CC;strokeDasharray=5,5;";
     label = "Hidden Checkbox";
     width = 150;
     height = 80;
   } else if (nodeType === 'hiddenTextbox') {
     style = "shape=roundRect;rounded=1;arcSize=20;whiteSpace=wrap;html=1;nodeType=hiddenTextbox;section=1;strokeWidth=3;strokeColor=#0066CC;strokeDasharray=5,5;";
     label = "Hidden Textbox";
     width = 150;
     height = 80;
   } else if (nodeType === 'linkedLogic') {
     style = "shape=roundRect;rounded=1;arcSize=20;whiteSpace=wrap;html=1;nodeType=linkedLogic;section=1;fillColor=#DDA0DD;strokeColor=#9370DB;";
     label = "Linked Logic";
     width = 150;
     height = 80;
   }
   ```

2. ADDED PROPER INITIALIZATION LOGIC:
   ```javascript
   } else if (nodeType === 'hiddenCheckbox') {
     cell._hiddenNodeId = "hidden_checkbox";
     if (typeof window.updateHiddenCheckboxNodeCell === 'function') {
       window.updateHiddenCheckboxNodeCell(cell);
     }
   } else if (nodeType === 'hiddenTextbox') {
     cell._hiddenNodeId = "hidden_textbox";
     cell._defaultText = "";
     if (typeof window.updateHiddenTextboxNodeCell === 'function') {
       window.updateHiddenTextboxNodeCell(cell);
     }
   } else if (nodeType === 'linkedLogic') {
     cell._linkedLogicNodeId = "linked_logic";
     cell._linkedFields = [];
     if (typeof window.updateLinkedLogicNodeCell === 'function') {
       window.updateLinkedLogicNodeCell(cell);
     }
   }
   ```

CODE CHANGES:
=============
1. Added missing node type cases in `placeNodeAtClickLocation` function:
   - Added `hiddenCheckbox` case with proper styling and dimensions
   - Added `hiddenTextbox` case with proper styling and dimensions
   - Added `linkedLogic` case with proper styling and dimensions

2. Added proper initialization logic for each node type:
   - Hidden Checkbox: Sets `_hiddenNodeId` and calls `updateHiddenCheckboxNodeCell`
   - Hidden Textbox: Sets `_hiddenNodeId`, `_defaultText` and calls `updateHiddenTextboxNodeCell`
   - Linked Logic: Sets `_linkedLogicNodeId`, `_linkedFields` and calls `updateLinkedLogicNodeCell`

3. Applied consistent styling:
   - Hidden nodes: Blue dashed border (`strokeColor=#0066CC;strokeDasharray=5,5`)
   - Linked Logic: Light purple fill (`fillColor=#DDA0DD;strokeColor=#9370DB`)
   - All nodes: Proper dimensions (150x80)

KEY LEARNINGS:
==============
1. When adding new node types, ensure both drag-and-drop AND right-click menu support them
2. Right-click menu node creation must mirror drag-and-drop node creation exactly
3. Always include proper initialization logic for special node types
4. Check that all node types have proper styling, dimensions, and default properties
5. Test both creation methods to ensure consistency

PREVENTION:
===========
- When adding new node types, update both `createNode()` in nodes.js AND `placeNodeAtClickLocation()` in context-menus.js
- Always include proper initialization logic for special node types
- Use the same styling, dimensions, and properties for both creation methods
- Test right-click menu creation against drag-and-drop creation for all node types

RELATED FILES:
=============
- context-menus.js (main file with right-click menu logic)
- nodes.js (drag-and-drop node creation logic to replicate)
- graph.js (double-click handlers for properties menus)

FUTURE REFERENCE:
================
When adding new special node types:
1. Add the node type case to `placeNodeAtClickLocation()` function
2. Include proper styling, dimensions, and label
3. Add initialization logic with default properties
4. Call the appropriate update function
5. Test both drag-and-drop and right-click menu creation
6. Ensure double-click functionality works correctly

PATTERN FOR NEW NODE TYPES:
===========================
```javascript
// 1. Add styling case
} else if (nodeType === 'newNodeType') {
  style = "proper;styling;string;";
  label = "Node Label";
  width = 150;
  height = 80;
}

// 2. Add initialization case
} else if (nodeType === 'newNodeType') {
  cell._newNodeProperty = "default_value";
  if (typeof window.updateNewNodeTypeCell === 'function') {
    window.updateNewNodeTypeCell(cell);
  }
}
```

=====================================

INCIDENT: PDF ID Generation Using Wrong Property Field
DATE: [Current Date]
ISSUE ID: PDF_ID_GENERATION_001

PROBLEM DESCRIPTION:
===================
Copy ID buttons for form fields and location IDs were generating incorrect IDs that used the PDF Name field ("Test") instead of the PDF File field ("example.pdf"). This resulted in IDs like "test_q1_name_1" instead of the expected "example_q1_name_1".

WHAT WE WERE ATTEMPTING TO DO:
=============================
- Make Copy ID buttons use the PDF File field value (e.g., "example.pdf") instead of PDF Name field value (e.g., "Test")
- Ensure location ID generation also uses the PDF File field
- Sanitize the PDF filename by removing the .pdf extension before using it in IDs

ISSUES ENCOUNTERED:
==================
1. PROPERTY FIELD MISMATCH:
   - The PDF Node Properties dialog stores the filename in `_pdfFile` property
   - The ID generation functions were looking for `_pdfFilename` property (which doesn't exist)
   - This caused a fallback to `_pdfName` property ("Test") instead of using `_pdfFile` ("example.pdf")

2. INCONSISTENT PROPERTY NAMES:
   - Dialog field "PDF File" maps to `_pdfFile` property
   - ID generation was looking for `_pdfFilename` property
   - No `_pdfFilename` property was being set anywhere in the code

3. MULTIPLE FUNCTIONS AFFECTED:
   - `copyMultipleTextboxId` function in script.js
   - `copyMultipleDropdownId` function in questions.js
   - `showLocationIdsPopup` function in script.js
   - `showDropdownLocationIdsPopup` function in script.js

TECHNICAL DETAILS:
==================
- Files: script.js, questions.js
- Function: `findPdfNameForQuestion()` in both files
- The function was checking: `startCell._pdfFilename || startCell._pdfUrl || startCell._pdfName`
- But the actual property being set was: `startCell._pdfFile`
- This caused the function to skip `_pdfFilename` (doesn't exist) and `_pdfUrl` (empty) and use `_pdfName` ("Test")

SOLUTION THAT WORKED:
====================
1. FIXED PROPERTY FIELD NAMES:
   ```javascript
   // Before (incorrect):
   if (startCell._pdfName || startCell._pdfFilename || startCell._pdfUrl) {
     return {
       filename: startCell._pdfFilename || startCell._pdfUrl || startCell._pdfName || "",
       // ...
     };
   }
   
   // After (correct):
   if (startCell._pdfName || startCell._pdfFile || startCell._pdfUrl) {
     return {
       filename: startCell._pdfFile || startCell._pdfUrl || startCell._pdfName || "",
       // ...
     };
   }
   ```

2. UPDATED ALL OCCURRENCES:
   - Fixed `findPdfNameForQuestion()` function in script.js (2 locations)
   - Fixed `findPdfNameForQuestion()` function in questions.js (2 locations)
   - Updated location ID generation functions to use PDF filename

3. MAINTAINED PROPER PRIORITY:
   - `_pdfFile` (PDF File field) - highest priority
   - `_pdfUrl` (PDF URL field) - second priority  
   - `_pdfName` (PDF Name field) - fallback

CODE CHANGES:
=============
1. In script.js `findPdfNameForQuestion()` function:
   - Changed `startCell._pdfFilename` to `startCell._pdfFile` (2 locations)
   - Updated property checks and filename assignment

2. In questions.js `findPdfNameForQuestion()` function:
   - Changed `startCell._pdfFilename` to `startCell._pdfFile` (2 locations)
   - Updated property checks and filename assignment

3. In location ID generation functions:
   - Added PDF filename detection using updated `findPdfNameForQuestion()`
   - Added PDF filename sanitization using `sanitizePdfName()`
   - Updated prefix generation to include PDF filename

KEY LEARNINGS:
==============
1. Always verify that property names match between dialog fields and ID generation functions
2. Check the actual property names being set in the dialog, not assumed names
3. When multiple functions use the same logic, update all of them consistently
4. Test with actual data to ensure the correct property is being used
5. Property field names in dialogs may not match the internal property names

PREVENTION:
===========
- When adding new dialog fields, verify the property name mapping
- Check that ID generation functions use the correct property names
- Test Copy ID functionality with actual data to ensure correct values are used
- Document property name mappings between dialogs and internal functions
- Use consistent property naming conventions across the codebase

RELATED FILES:
=============
- script.js (main ID generation functions)
- questions.js (dropdown ID generation functions)
- PDF Node Properties dialog (sets _pdfFile property)

FUTURE REFERENCE:
================
When working with PDF properties and ID generation:
1. Verify the actual property name being set in the dialog
2. Check that ID generation functions use the same property name
3. Test with actual data to ensure correct values are being used
4. Update all related functions consistently
5. Maintain proper priority order: _pdfFile > _pdfUrl > _pdfName

PROPERTY MAPPING REFERENCE:
===========================
- PDF Name field → `_pdfName` property
- PDF File field → `_pdfFile` property  
- PDF Price field → `_pdfPrice` property
- PDF URL field → `_pdfUrl` property (if exists)

ID GENERATION PRIORITY:
======================
1. `_pdfFile` (PDF File field) - preferred for filenames
2. `_pdfUrl` (PDF URL field) - fallback for URLs
3. `_pdfName` (PDF Name field) - final fallback for display names

=====================================

INCIDENT: Draggable Popup Teleporting Issue
DATE: [Current Date]
ISSUE ID: DRAGGABLE_POPUP_TELEPORT_001

PROBLEM DESCRIPTION:
===================
When trying to drag a popup (specifically the Location IDs popup), the popup would "teleport" or jump to an unexpected position when the user started dragging. The popup would move to a location that was offset from where the user's mouse cursor was, making dragging feel broken and unpredictable.

WHAT WE WERE ATTEMPTING TO DO:
=============================
- Make the Location IDs popup draggable by clicking and dragging the header
- Ensure smooth, predictable dragging behavior that follows the mouse cursor
- Allow users to move the popup to any position on screen

ISSUES ENCOUNTERED:
==================
1. TRANSFORM CONFLICTS:
   - The popup was initially centered using `transform: translate(-50%, -50%)`
   - When dragging started, we were applying a new transform that conflicted with the original centering
   - This caused the popup to "teleport" to an unexpected position

2. POSITIONING CALCULATION ERRORS:
   - The drag logic was trying to calculate positions relative to the original centered position
   - But the mouse position was relative to the current screen position
   - This mismatch caused the teleporting behavior

3. INCONSISTENT POSITIONING METHODS:
   - Initial positioning used `transform: translate(-50%, -50%)`
   - Dragging used `transform: translate(x, y)` 
   - These two transform methods conflicted with each other

TECHNICAL DETAILS:
==================
- File: script.js
- Function: `makePopupDraggable(popup)`
- The popup was initially positioned with CSS: `top: 50%; left: 50%; transform: translate(-50%, -50%)`
- When dragging started, we were applying: `popup.style.transform = 'translate(${currentX}px, ${currentY}px)'`
- This created a conflict between the centering transform and the dragging transform

SOLUTION THAT WORKED:
====================
1. CLEAN TRANSITION FROM CENTERING TO DRAGGING:
   ```javascript
   function dragStart(e) {
     // Get the current actual position of the popup
     const rect = popup.getBoundingClientRect();
     initialX = rect.left;
     initialY = rect.top;
     
     // Get the mouse position relative to the popup
     startX = e.clientX - initialX;
     startY = e.clientY - initialY;
     
     // Remove the centering transform and set absolute positioning
     popup.style.top = initialY + 'px';
     popup.style.left = initialX + 'px';
     popup.style.transform = 'none';
   }
   ```

2. USE ABSOLUTE POSITIONING FOR DRAGGING:
   ```javascript
   function drag(e) {
     if (isDragging) {
       e.preventDefault();
       
       const newX = e.clientX - startX;
       const newY = e.clientY - startY;
       
       popup.style.left = newX + 'px';
       popup.style.top = newY + 'px';
     }
   }
   ```

3. PROPER INITIAL POSITIONING:
   ```javascript
   // Set initial centered position
   popup.style.top = '50%';
   popup.style.left = '50%';
   popup.style.transform = 'translate(-50%, -50%)';
   ```

CODE CHANGES:
=============
1. Modified `makePopupDraggable()` function in script.js:
   - Added proper initial positioning setup
   - Fixed `dragStart()` to get actual popup position using `getBoundingClientRect()`
   - Calculate mouse offset relative to popup position
   - Remove centering transform and switch to absolute positioning
   - Use `top` and `left` properties instead of `transform` for dragging

2. Key improvements:
   - Get actual popup position before dragging starts
   - Calculate mouse offset relative to popup, not screen
   - Clean transition from centering transform to absolute positioning
   - Use consistent positioning method throughout dragging

KEY LEARNINGS:
==============
1. Don't mix `transform` and `top/left` positioning methods for draggable elements
2. Always get the actual element position using `getBoundingClientRect()` before starting drag
3. Calculate mouse offset relative to the element, not the screen
4. Make a clean transition from initial positioning to dragging positioning
5. Use absolute positioning (`top`/`left`) for dragging instead of `transform`

PREVENTION:
===========
- When making elements draggable, always get their actual position first
- Don't mix positioning methods (transform vs top/left)
- Calculate mouse offset relative to the element being dragged
- Make a clean transition from initial positioning to dragging positioning
- Test dragging behavior thoroughly to ensure smooth, predictable movement

RELATED FILES:
=============
- script.js (main file with draggable popup logic)

FUTURE REFERENCE:
================
When implementing draggable popups:
1. Set initial position with CSS (centered or fixed position)
2. In dragStart: Get actual position using `getBoundingClientRect()`
3. Calculate mouse offset relative to the popup position
4. Remove initial positioning transform and switch to absolute positioning
5. Use `top` and `left` properties for dragging, not `transform`
6. Test dragging behavior to ensure smooth, predictable movement

DRAGGABLE POPUP PATTERN:
========================
```javascript
function makePopupDraggable(popup) {
  let isDragging = false;
  let startX, startY, initialX, initialY;

  // Set initial centered position
  popup.style.top = '50%';
  popup.style.left = '50%';
  popup.style.transform = 'translate(-50%, -50%)';

  function dragStart(e) {
    isDragging = true;
    
    // Get actual position
    const rect = popup.getBoundingClientRect();
    initialX = rect.left;
    initialY = rect.top;
    
    // Calculate mouse offset
    startX = e.clientX - initialX;
    startY = e.clientY - initialY;
    
    // Switch to absolute positioning
    popup.style.top = initialY + 'px';
    popup.style.left = initialX + 'px';
    popup.style.transform = 'none';
  }

  function drag(e) {
    if (isDragging) {
      e.preventDefault();
      const newX = e.clientX - startX;
      const newY = e.clientY - startY;
      popup.style.left = newX + 'px';
      popup.style.top = newY + 'px';
    }
  }
}
```

=====================================

INCIDENT: Conditional Logic Implementation Documentation
DATE: [Current Date]
ISSUE ID: CONDITIONAL_LOGIC_DOC_001

PURPOSE:
========
This documentation explains how conditional logic works in the FormWiz GUI system. Conditional logic allows questions to be shown or hidden based on answers to previous questions. This documentation is intended to serve as a reference when implementing conditional logic for new question types.

OVERVIEW:
=========
Conditional logic in FormWiz uses a "show if" pattern:
- A question can have conditional logic enabled
- When enabled, the question is hidden by default
- The question is shown only when specific conditions are met
- Conditions are based on answers to previous questions
- Multiple conditions can be combined with OR logic (if ANY condition matches, show the question)

EXAMPLE SCENARIO:
=================
Given this JSON configuration:
```json
{
  "questionId": 1,
  "text": "Hungry?",
  "type": "dropdown",
  "logic": {
    "enabled": false,
    "conditions": []
  },
  "options": ["Yes", "No"]
},
{
  "questionId": 2,
  "text": "Thirsty?",
  "type": "dropdown",
  "logic": {
    "enabled": true,
    "conditions": [
      {
        "prevQuestion": "1",
        "prevAnswer": "Yes"
      }
    ]
  },
  "options": ["Yes", "No"]
},
{
  "questionId": 3,
  "text": "Sleepy?",
  "type": "dropdown",
  "logic": {
    "enabled": true,
    "conditions": [
      {
        "prevQuestion": "1",
        "prevAnswer": "No"
      }
    ]
  },
  "options": ["Yes", "No"]
}
```

Result:
- Question 1 ("Hungry?") is always visible (no conditional logic)
- Question 2 ("Thirsty?") is hidden until user selects "Yes" in Question 1
- Question 3 ("Sleepy?") is hidden until user selects "No" in Question 1

JSON STRUCTURE:
===============
The conditional logic configuration is stored in the question object:

```json
{
  "questionId": 2,
  "logic": {
    "enabled": true,           // Boolean: Is conditional logic enabled?
    "conditions": [            // Array: List of conditions (OR logic)
      {
        "prevQuestion": "1",   // String: ID of the previous question to check
        "prevAnswer": "Yes"    // String: Answer value that triggers this question
      }
    ]
  }
}
```

KEY PROPERTIES:
---------------
- `logic.enabled`: Boolean flag indicating if conditional logic is active
- `logic.conditions`: Array of condition objects
- `condition.prevQuestion`: Question ID (as string) of the question to check
- `condition.prevAnswer`: Answer value (as string) that must match

IMPLEMENTATION FLOW:
====================

PHASE 1: GUI CONFIGURATION (gui.js)
------------------------------------
Location: FormWiz GUI/gui.js

1. USER INTERFACE SETUP:
   - When user enables conditional logic checkbox, a UI is shown
   - User can add multiple condition rows
   - Each row has:
     - "Previous Question" input: User enters question number (e.g., "1")
     - "Previous Answer" dropdown: Populated based on selected question type

2. QUESTION TYPE DETECTION:
   Function: `updateLogicAnswersForRow(questionId, conditionIndex)`
   - Reads the question number from input field
   - Finds the target question block: `document.getElementById('questionBlock' + prevQNum)`
   - Gets question type: `targetQuestionBlock.querySelector('#questionType' + prevQNum)?.value`

3. ANSWER OPTIONS POPULATION:
   Based on question type, different options are populated:
   
   - **Radio/Yes-No**: Shows "Yes" and "No" options
   - **Dropdown**: Iterates through dropdown options from the question
   - **Checkbox**: Shows all checkbox options + "None of the above" if enabled
   - **Numbered Dropdown**: Shows range of numbers (min to max)
   - **Text/Date/Money**: Hides dropdown, shows label "Will trigger when any text is entered"

4. CONDITION DATA STORAGE:
   When user saves the form, conditions are extracted:
   ```javascript
   const logicRows = qBlock.querySelectorAll(".logic-condition-row");
   logicRows.forEach((row, index) => {
     const prevQuestion = row.querySelector(`#prevQuestion${questionId}_${index+1}`).value;
     const prevAnswer = row.querySelector(`#prevAnswer${questionId}_${index+1}`).value;
     conditions.push({ prevQuestion, prevAnswer });
   });
   ```

PHASE 2: HTML GENERATION (generate.js)
---------------------------------------
Location: FormWiz GUI/generate.js
Lines: ~1956-2054

1. HTML STRUCTURE CREATION:
   - Each question is wrapped in a container: `<div id="question-container-{questionId}">`
   - Questions with conditional logic get the "hidden" class initially:
     ```html
     <div id="question-container-2" class="question-container hidden">
     ```

2. JAVASCRIPT GENERATION:
   For each question with conditional logic enabled, a self-executing function is generated:

   ```javascript
   (function(){
     var thisQ = document.getElementById("question-container-2");
     
     function updateVisibility(){
       var anyMatch = false;
       
       // For each condition, check if it matches
       (function(){
         var cPrevType = "dropdown";
         var cPrevAns = "yes";
         var cPrevQNum = "1";
         
         if(cPrevType === "checkbox"){
           // Checkbox handling (see below)
         } else {
           // Other question types (see below)
         }
       })();
       
       // Show or hide based on match
       if(anyMatch){
         thisQ.classList.remove("hidden");
       } else {
         thisQ.classList.add("hidden");
       }
     }
     
     // Attach event listeners to trigger question
     // Call updateVisibility() on page load
   })();
   ```

3. CONDITION CHECKING LOGIC:
   
   A. CHECKBOX QUESTIONS:
   ```javascript
   if(cPrevType === "checkbox"){
     var questionContainer = document.getElementById('question-container-' + cPrevQNum);
     var cbs = questionContainer ? questionContainer.querySelectorAll('input[type="checkbox"], input[type="radio"]') : [];
     var checkedVals = [];
     for(var cc=0; cc<cbs.length; cc++){
       if(cbs[cc].checked) {
         checkedVals.push(cbs[cc].value.trim().toLowerCase());
       }
     }
     if(checkedVals.indexOf(cPrevAns) !== -1){
       anyMatch = true;
     }
   }
   ```
   
   B. DROPDOWN/TEXT/OTHER QUESTIONS:
   ```javascript
   else {
     var el2 = document.getElementById(questionNameIds[cPrevQNum]) || 
               document.getElementById("answer" + cPrevQNum);
     if(el2){
       var val2 = el2.value.trim().toLowerCase();
       if(val2 === cPrevAns){
         anyMatch = true;
       }
     }
   }
   ```

4. ELEMENT IDENTIFICATION:
   The system uses a `questionNameIds` object to map question IDs to their actual DOM element IDs:
   ```javascript
   var questionNameIds = {"1":"hungry","2":"thristy","3":"sleepy"};
   ```
   
   Element lookup priority:
   1. `document.getElementById(questionNameIds[questionId])` - Preferred (uses nameId)
   2. `document.getElementById("answer" + questionId)` - Fallback (uses default ID)

5. EVENT LISTENER ATTACHMENT:
   After generating the condition checking logic, event listeners are attached to the trigger question:
   
   ```javascript
   // For checkbox questions
   var questionContainer = document.getElementById('question-container-' + selectQuestion);
   var cbs = questionContainer ? questionContainer.querySelectorAll('input[type="checkbox"], input[type="radio"]') : [];
   for(var i=0; i<cbs.length; i++){
     cbs[i].addEventListener("change", function(){ updateVisibility(); });
   }
   
   // For dropdown/select questions
   var el3 = document.getElementById(questionNameIds[selectQuestion]) || 
             document.getElementById("answer" + selectQuestion);
   if(el3){
     el3.addEventListener("change", function(){ updateVisibility(); });
   }
   
   // For text input questions
   var el3 = document.getElementById(questionNameIds[textQuestion]) || 
             document.getElementById("answer" + textQuestion);
   if(el3){
     el3.addEventListener("input", function(){ updateVisibility(); });
   }
   ```

6. INITIAL VISIBILITY CHECK:
   After all event listeners are attached, `updateVisibility()` is called immediately:
   ```javascript
   updateVisibility();
   ```
   This ensures questions are shown/hidden correctly on page load.

PHASE 3: RUNTIME EXECUTION (Generated HTML)
--------------------------------------------
Location: Generated output.html

1. PAGE LOAD:
   - All question containers are rendered
   - Questions with conditional logic have "hidden" class
   - Self-executing functions run immediately
   - `updateVisibility()` is called for each conditional question
   - Initial visibility is set based on current form state

2. USER INTERACTION:
   When user changes an answer in a trigger question:
   - Event listener fires (change event for dropdowns, input event for text)
   - `updateVisibility()` function is called
   - All conditions are checked
   - If ANY condition matches (`anyMatch = true`), question is shown
   - If NO conditions match (`anyMatch = false`), question is hidden

3. MULTIPLE CONDITIONS (OR LOGIC):
   If a question has multiple conditions:
   ```json
   "conditions": [
     {"prevQuestion": "1", "prevAnswer": "Yes"},
     {"prevQuestion": "2", "prevAnswer": "No"}
   ]
   ```
   The question is shown if EITHER condition matches (OR logic).

SPECIAL CASES:
==============

1. TEXT/INPUT QUESTIONS:
   - For text, date, money, and dateRange questions, there are no predefined options
   - Special condition values are used: "Any Text", "Any Amount", "Any Date"
   - These check for presence of any value, not exact match:
   ```javascript
   if(paVal.toLowerCase() === "any text" || 
      paVal.toLowerCase() === "any amount" || 
      paVal.toLowerCase() === "any date"){
     if(el2){
       var val2 = el2.value.trim();
       if(val2 !== ""){
         anyMatch = true;
       }
     }
   }
   ```

2. CHECKBOX QUESTIONS:
   - Checkboxes can have multiple checked options
   - The system checks if ANY checked option matches the condition
   - Works for both regular checkboxes and "Mark Only One" (radio buttons)

3. NUMBERED DROPDOWN QUESTIONS:
   - Condition answer is compared as a string (e.g., "1", "2", "3")
   - The actual value in the form is the selected number from the range

4. CASE INSENSITIVITY:
   - All comparisons use `.toLowerCase()` for case-insensitive matching
   - "Yes" matches "yes", "YES", "YeS", etc.

5. QUESTION NAME IDS:
   - The `questionNameIds` object maps question IDs to their actual DOM element IDs
   - This allows questions to have custom IDs (from `nameId` field) instead of default "answer{N}"
   - Lookup tries `questionNameIds[questionId]` first, then falls back to `"answer" + questionId`

VISIBILITY CSS:
===============
The "hidden" class is defined in the generated HTML:
```css
.hidden {
  display: none !important;
}
```

When a condition matches:
- `thisQ.classList.remove("hidden")` - Shows the question
When no conditions match:
- `thisQ.classList.add("hidden")` - Hides the question

IMPLEMENTING CONDITIONAL LOGIC FOR NEW QUESTION TYPES:
=======================================================

STEP 1: UPDATE GUI CONFIGURATION (gui.js)
------------------------------------------
1. In `updateLogicAnswersForRow()` function, add handling for your new question type:
   ```javascript
   } else if (questionType === 'yourNewType') {
     // Populate answer options based on your question type
     const options = getOptionsForYourNewType(prevQNum);
     options.forEach(option => {
       const optionEl = document.createElement('option');
       optionEl.value = option;
       optionEl.textContent = option;
       answerSelect.appendChild(optionEl);
     });
   }
   ```

STEP 2: UPDATE HTML GENERATION (generate.js)
---------------------------------------------
1. In the condition checking logic (around line 1985), add handling:
   ```javascript
   } else if (cPrevType === "yourNewType") {
     // Add logic to check if condition matches
     var el2 = document.getElementById(questionNameIds[cPrevQNum]) || 
               document.getElementById("answer" + cPrevQNum);
     if(el2){
       var val2 = el2.value.trim().toLowerCase();
       if(val2 === cPrevAns){
         anyMatch = true;
       }
     }
   }
   ```

2. In the event listener attachment section (around line 2030), add handling:
   ```javascript
   } else if (pType2 === "yourNewType") {
     logicScriptBuffer += ` (function(){\n`;
     logicScriptBuffer += `   var yourNewTypeQuestion = "${pqVal2}";\n`;
     logicScriptBuffer += `   var el3= document.getElementById(questionNameIds[yourNewTypeQuestion]) || document.getElementById("answer"+yourNewTypeQuestion);\n`;
     logicScriptBuffer += `   if(el3){ el3.addEventListener("change", function(){ updateVisibility();});}\n`;
     logicScriptBuffer += ` })();\n`;
   }
   ```
   
   Note: Use "change" event for dropdowns/selects, "input" event for text fields

STEP 3: ENSURE PROPER ELEMENT IDS
-----------------------------------
1. Make sure your question type generates elements with proper IDs
2. The ID should either:
   - Be stored in `questionNameIds` object (if using `nameId` field)
   - Or follow the pattern `"answer" + questionId`

STEP 4: TEST THOROUGHLY
------------------------
1. Test with multiple conditions (OR logic)
2. Test with different answer values
3. Test case sensitivity
4. Test on page load (initial visibility)
5. Test when user changes answers
6. Test with multiple questions depending on the same trigger question

COMMON PITFALLS:
================

1. WRONG EVENT TYPE:
   - Using "input" for dropdowns (should use "change")
   - Using "change" for text fields (should use "input")
   - Solution: Check what type of element your question generates

2. WRONG ELEMENT ID:
   - Not using `questionNameIds` lookup
   - Hardcoding element IDs
   - Solution: Always use: `questionNameIds[questionId] || "answer" + questionId`

3. CASE SENSITIVITY:
   - Forgetting to use `.toLowerCase()` in comparisons
   - Solution: Always compare lowercased values

4. CHECKBOX HANDLING:
   - Treating checkboxes like dropdowns
   - Solution: Use special checkbox handling that checks all checked values

5. INITIAL VISIBILITY:
   - Forgetting to call `updateVisibility()` on page load
   - Solution: Always include `updateVisibility();` after event listener setup

DEBUGGING:
==========
The generated code includes console.log statements for debugging:
```javascript
console.log('🔧 [CONDITIONAL DEBUG] Question 1: Found', cbs.length, 'inputs in container, looking for:', cPrevAns);
console.log('🔧 [CONDITIONAL DEBUG] Checked values:', checkedVals, 'Looking for:', cPrevAns);
console.log('🔧 [CONDITIONAL DEBUG] ✅ MATCH FOUND!');
```

To debug conditional logic:
1. Open browser console
2. Change answers in trigger questions
3. Look for conditional debug messages
4. Check if `anyMatch` is being set correctly
5. Verify element IDs are correct
6. Check if event listeners are firing

SUMMARY:
========
Conditional logic in FormWiz works by:
1. Storing conditions in JSON (prevQuestion, prevAnswer)
2. Generating JavaScript that checks conditions on page load and when answers change
3. Using CSS class "hidden" to show/hide questions
4. Supporting OR logic (multiple conditions, any can match)
5. Using case-insensitive matching
6. Supporting special question types (checkbox, text, etc.)

KEY FILES:
==========
- FormWiz GUI/gui.js: GUI configuration and condition setup
- FormWiz GUI/generate.js: HTML/JavaScript generation (lines ~1956-2054)
- Generated output.html: Runtime execution

KEY FUNCTIONS:
==============
- `updateLogicAnswersForRow()`: Populates answer options based on question type
- Condition checking logic: Generated in `generate.js`, executed in output.html
- `updateVisibility()`: Shows/hides questions based on conditions

RELATED FILES:
=============
- FormWiz GUI/gui.js (GUI configuration)
- FormWiz GUI/generate.js (HTML generation)
- FormWiz GUI/output.html (generated form with runtime logic)

FUTURE REFERENCE:
=================
When implementing conditional logic for new question types:
1. Add question type handling in `updateLogicAnswersForRow()` in gui.js
2. Add condition checking logic in generate.js (around line 1985)
3. Add event listener attachment in generate.js (around line 2030)
4. Ensure proper element IDs are generated
5. Test thoroughly with multiple conditions and scenarios
6. Use the debugging console.log statements to verify behavior

=====================================

INCIDENT: Conditional Logic for Date Fields in Trigger Sequences Not Working
DATE: [Current Date]
ISSUE ID: CONDITIONAL_LOGIC_DATE_FIELDS_001

PROBLEM DESCRIPTION:
===================
Date fields within trigger sequences had conditional logic configured, but the date field was always visible even when the required checkbox was not checked. The conditional logic was defined in the GUI JSON (output.json) with `conditionalLogic: { enabled: true, conditions: [...] }`, but when the HTML was generated, the date field appeared regardless of checkbox state.

WHAT WE WERE ATTEMPTING TO DO:
=============================
- Make date fields within trigger sequences conditionally visible based on checkbox selections
- Only show the date field when the user checks the specified checkbox option
- Hide the date field by default when conditional logic is enabled
- Ensure the conditional logic data flows correctly from GUI JSON → unifiedFieldsMap → generated HTML

ISSUES ENCOUNTERED:
==================
1. CONDITIONAL LOGIC DATA NOT IN UNIFIEDFIELDSMAP:
   - When `generate.js` built the `unifiedFieldsMap` from the GUI editor's DOM, it wasn't reading `conditionalLogic` from `window.triggerDateConditionalLogic`
   - The date field in `triggerFields` array was missing the `conditionalLogic` property
   - This caused `createTriggerFieldsContainer` to receive date fields without conditional logic data
   - Result: `triggerField.conditionalLogic` was `undefined` in the generated HTML

2. DATA FLOW GAP:
   - `download.js` correctly stored `conditionalLogic` in `window.triggerDateConditionalLogic` when importing GUI JSON
   - But `generate.js` was building `triggerFields` by reading from the DOM, not from `window.triggerDateConditionalLogic`
   - The conditional logic data existed in memory but wasn't being used when building the trigger fields

3. INITIAL HIDING ISSUE:
   - Even when conditional logic was eventually detected, the date field wasn't being hidden initially
   - The field was visible on page load even when no checkboxes were checked

TECHNICAL DETAILS:
==================
- File: FormWiz GUI/generate.js
- Function: Building `triggerFields` array (around line 1710-1740)
- The code was creating date field objects like this:
  ```javascript
  triggerFields.push({
    type: 'date',
    label: dateLabelEl.value.trim(),
    nodeId: dateNodeIdEl.value.trim()
    // Missing: conditionalLogic property
  });
  ```
- `window.triggerDateConditionalLogic` structure:
  ```javascript
  {
    "2_4_1_1": {  // Key format: questionId_fieldOrder_sequenceIndex_triggerFieldCount
      enabled: true,
      conditions: ["is_this_plaintiff_a_business_yes_what_do_they_do_business_as_an_individual"]
    }
  }
  ```

SOLUTION THAT WORKED:
====================
1. READ CONDITIONAL LOGIC WHEN BUILDING TRIGGER FIELDS:
   ```javascript
   } else if (dateLabelEl && dateNodeIdEl) {
     // Trigger date field
     const dateField = {
       type: 'date',
       label: dateLabelEl.value.trim(),
       nodeId: dateNodeIdEl.value.trim()
     };
     
     // Check for conditional logic from window.triggerDateConditionalLogic
     const triggerFieldCount = fieldIndex + 1;
     const conditionalLogicKey = `${questionId}_${fieldOrder}_${sequenceIndex + 1}_${triggerFieldCount}`;
     if (window.triggerDateConditionalLogic && window.triggerDateConditionalLogic[conditionalLogicKey]) {
       const storedLogic = window.triggerDateConditionalLogic[conditionalLogicKey];
       if (storedLogic.enabled && storedLogic.conditions && storedLogic.conditions.length > 0) {
         dateField.conditionalLogic = {
           enabled: storedLogic.enabled,
           conditions: storedLogic.conditions.filter(c => c && c.trim() !== '')
         };
       }
     }
     
     triggerFields.push(dateField);
   }
   ```

2. ENSURED INITIAL HIDING:
   - In `createTriggerFieldsContainer` function (in generated HTML), the date field is now hidden immediately when conditional logic is enabled:
   ```javascript
   if (hasConditionalLogic) {
     fieldDiv.style.cssText = '... display: none; ...';
   }
   ```

3. CLEANED UP CONSOLE LOGS:
   - Removed excessive debugging logs
   - Kept only essential logs for conditional logic debugging

CODE CHANGES:
=============
1. In FormWiz GUI/generate.js (around line 1710-1740):
   - Modified date field creation to check `window.triggerDateConditionalLogic`
   - Added logic to read conditional logic data using the correct key format
   - Added `conditionalLogic` property to date field object if found
   - Added debug logging to trace the conditional logic lookup

2. In FormWiz GUI/generate.js (around line 2566-2680):
   - Already had conditional logic implementation in `createTriggerFieldsContainer`
   - Ensured field is hidden immediately when conditional logic is enabled
   - Simplified console logs to reduce noise

KEY LEARNINGS:
==============
1. When building data structures from multiple sources (DOM + window variables), ensure all sources are checked
2. The key format for `window.triggerDateConditionalLogic` must match exactly: `questionId_fieldOrder_sequenceIndex_triggerFieldCount`
3. Conditional logic data stored in `window.triggerDateConditionalLogic` during import needs to be read when generating HTML
4. Always hide fields initially when conditional logic is enabled, then show them when conditions are met
5. Use multiple delayed checks (100ms, 500ms, 1000ms, 2000ms) to catch checkboxes that might be created after the date field

PREVENTION:
===========
- When importing GUI JSON, ensure conditional logic data is stored in a format that `generate.js` can read
- When building trigger fields, always check for conditional logic data in `window.triggerDateConditionalLogic`
- Use consistent key formats across all functions (download.js, generate.js, etc.)
- Test that conditional logic data flows correctly: GUI JSON → window variable → unifiedFieldsMap → generated HTML
- Always hide fields initially when conditional logic is enabled

RELATED FILES:
=============
- FormWiz GUI/generate.js (main file - builds triggerFields and generates HTML)
- FormWiz GUI/download.js (stores conditional logic in window.triggerDateConditionalLogic)
- FormWiz GUI/gui.js (manages conditional logic UI in GUI editor)
- FormWiz GUI/output.html (generated HTML with runtime conditional logic)

FUTURE REFERENCE:
================
When implementing conditional logic for trigger sequence fields:
1. Store conditional logic data in `window.triggerDateConditionalLogic` during import (download.js)
2. Read conditional logic data when building triggerFields (generate.js)
3. Use correct key format: `${questionId}_${fieldOrder}_${sequenceIndex + 1}_${triggerFieldCount}`
4. Include `conditionalLogic` property in the field object when building unifiedFieldsMap
5. In generated HTML, hide fields initially when conditional logic is enabled
6. Use retry logic to attach event listeners to checkboxes that might not exist yet
7. Use multiple delayed checks to catch checkboxes created after the conditional field

KEY FORMAT REFERENCE:
=====================
- Key format: `${questionId}_${fieldOrder}_${sequenceIndex + 1}_${triggerFieldCount}`
- Example: `2_4_1_1` means:
  - questionId: 2
  - fieldOrder: 4
  - sequenceIndex: 0 (shown as 1 in key, but 0-based in code)
  - triggerFieldCount: 1 (1-based index)

DATA FLOW:
==========
1. User configures conditional logic in GUI editor → stored in GUI JSON
2. GUI JSON imported → `download.js` stores in `window.triggerDateConditionalLogic`
3. HTML generation → `generate.js` reads from `window.triggerDateConditionalLogic`
4. Data included in `unifiedFieldsMap` → embedded in generated HTML
5. Runtime → `createTriggerFieldsContainer` receives date field with `conditionalLogic`
6. Conditional logic executed → date field shown/hidden based on checkbox state

=====================================