# Flowchart Creation Tool - Features Documentation

## üìö **Purpose of This Document**

This document serves as a comprehensive guide to understanding how all features in the Flowchart Creation Tool work. Each feature is documented in great detail, following the complete flow from **GUI setup** ‚Üí **generate.js processing** ‚Üí **output.html implementation**. 

The documentation is structured so clearly and thoroughly that when an AI agent needs to update or extend any feature, they can:
1. Understand the complete feature lifecycle
2. See exactly where changes need to be made
3. Understand how the feature interacts with other parts of the system
4. Implement updates without breaking existing functionality

**Documentation Structure for Each Feature:**
- **GUI Setup (gui.html/gui.js)**: How the feature is configured in the GUI editor
- **Data Flow (generate.js)**: How the feature data is processed during HTML generation
- **Output Implementation (output.html)**: How the feature works in the final generated form
- **Data Persistence**: How the feature is saved/loaded through export/import and autosave

---
## üìã **Table of Contents**
1. [Core Features](#core-features)
2. [Node Types](#node-types)
3. [Conditional Logic](#conditional-logic)
4. [Data Persistence](#data-persistence)
5. [User Interface](#user-interface)
6. [Advanced Features](#advanced-features)
7. [Integration Features](#integration-features)

---

## üéØ **Core Features**

### **1. Flowchart Creation & Editing**
- **Description**: Interactive flowchart creation using mxGraph library
- **Implementation**: 
  - `graph.js` - Core graph functionality and node creation
  - `index.html` - Main interface with toolbar and canvas
  - Drag-and-drop node creation from sidebar
  - Real-time editing with visual feedback
- **Key Functions**:
  - `createNode()` - Creates new nodes with specific types
  - `setupCustomDoubleClickBehavior()` - Handles node interactions
  - `updateNodeStyle()` - Applies visual styling to nodes

### **2. Node Management**
- **Description**: Comprehensive node type system with custom properties
- **Implementation**:
  - Multiple node types: textbox, dropdown, checkbox, radio, etc.
  - Custom properties for each node type
  - Dynamic property menus for configuration
- **Key Functions**:
  - `showPropertiesPopup()` - Displays node-specific property menus
  - `updateNodeProperties()` - Saves property changes
  - `isNodeType()` - Identifies node types for conditional logic

---

## üîß **Node Types**

### **1. Standard Question Nodes**
- **Textbox Questions**: Single-line text input
- **Dropdown Questions**: Select from predefined options
- **Checkbox Questions**: Multiple selection options
- **Radio Questions**: Single selection from options
- **Date Questions**: Date picker input
- **Number Questions**: Numeric input with validation
- **Email Questions**: Email format validation
- **Phone Questions**: Phone number formatting

### **2. Specialized Node Types**

#### **Hidden Checkbox Nodes**
- **Description**: Invisible checkboxes that appear when conditions are met
- **Visual**: Checked blue border (dashed) instead of solid
- **Properties**: Node ID input
- **Implementation**: `graph.js` - Custom styling and property handling
- **Key Features**:
  - Automatic Node ID sync with node text
  - Conditional display logic
  - Hidden from PDF reset functions

#### **Hidden Textbox Nodes**
- **Description**: Invisible text inputs that appear when conditions are met
- **Visual**: Checked blue border (dashed) instead of solid
- **Properties**: Node ID input, Default Text input
- **Implementation**: `graph.js` - Custom styling and property handling
- **Key Features**:
  - Automatic Node ID sync with node text
  - Default text preservation
  - Conditional display logic

#### **Linked Logic Nodes**
- **Description**: Light purple nodes that link multiple fields together
- **Visual**: Light purple background
- **Properties**: Multiple dropdown selections, Node ID input
- **Implementation**: `graph.js` - Custom property menu with searchable dropdowns
- **Key Features**:
  - Dynamic dropdown population with search functionality
  - Keyword-based search (e.g., "dog happy toy" finds "the dog is happy to get his toy")
  - Save button to persist changes
  - Custom dropdown UI with real-time filtering

#### **Big Paragraph Nodes**
- **Description**: Multi-line text areas with character/line limits
- **Properties**: Character limit, line limit, paragraph limit, Copy ID button
- **Implementation**: `graph.js` - Custom property handling
- **Key Features**:
  - Copy ID button appends "_overlimit" to node ID
  - Multiple limit types for different validation needs

#### **Sample Question Nodes**
- **Description**: Pre-configured dropdown with Yes/No options
- **Implementation**: `context-menus.js` - `placeSampleQuestion()` function
- **Key Features**:
  - Automatic "Hungry?" dropdown creation
  - Connected Yes/No option nodes
  - Right-click context menu integration

### **3. Multiple Entry Node Types**

#### **Multiple Dropdown Questions**
- **Description**: Dynamic number of dropdown entries based on user selection
- **Implementation**: `graph.js` - `showTextboxLabels()` function
- **Key Features**:
  - Range-based entry generation (e.g., 1-3 creates 3 entries)
  - Location data support (street, city, state, zip, state_short)
  - Hierarchical dragging (moves connected nodes)
  - Copy ID functionality with proper formatting

#### **Multiple Textbox Questions**
- **Description**: Dynamic number of text input entries
- **Implementation**: `graph.js` - Similar to multiple dropdowns
- **Key Features**:
  - Location data support
  - Hidden address textbox generation
  - Automatic address field updates

---

## ‚ö° **Conditional Logic**

### **1. Question Visibility Logic**
- **Description**: Show/hide questions based on previous answers
- **Implementation**: `generate.js` - Conditional logic generation
- **Key Features**:
  - Dynamic condition evaluation
  - Real-time visibility updates
  - Support for checkbox, dropdown, and text conditions

### **2. Business Type Conditional Logic**
- **Description**: Automatically show county question when business type is selected
- **Implementation**: `generate.js` - Dynamic event listener setup
- **Key Features**:
  - Dynamic question name resolution using `questionNameIds`
  - Automatic event listener attachment
  - No hardcoded question names
- **Code Location**: `generate.js` - `setupBusinessTypeConditionalLogic()` function

### **3. Hidden Logic System**
- **Description**: Create hidden elements when conditions are met
- **Implementation**: `generate.js` - `updateHiddenLogic()` function
- **Key Features**:
  - Dynamic hidden element creation
  - Support for checkboxes and textboxes
  - Integration with form submission

---

## üíæ **Data Persistence**

### **1. Autosave System**
- **Description**: Automatic saving of flowchart state
- **Implementation**: `script.js` - Autosave functionality
- **Key Features**:
  - Periodic automatic saves
  - Library flowchart name preservation
  - Restore on page reload with user confirmation
- **Code Location**: `script.js` - Autosave functions

### **2. Library Save/Load**
- **Description**: Save flowcharts to Firebase for later use
- **Implementation**: `library.js` - Firebase integration
- **Key Features**:
  - User authentication required
  - Multiple flowchart storage per user
  - Last used timestamp tracking
  - Search functionality
- **Key Functions**:
  - `saveFlowchart()` - Save current flowchart
  - `saveAsFlowchart()` - Save as new flowchart (NEW FEATURE)
  - `viewSavedFlowcharts()` - Display saved flowcharts

### **3. Import/Export JSON**
- **Description**: Export flowchart data as JSON for backup/sharing
- **Implementation**: `library.js` - JSON serialization
- **Key Features**:
  - Complete flowchart data export
  - All custom properties preserved
  - Cross-platform compatibility

### **4. Save As Functionality** ‚≠ê **NEW FEATURE**
- **Description**: Create new flowchart entries from current work
- **Implementation**: `library.js` - `saveAsFlowchart()` function
- **Key Features**:
  - Always prompts for new name
  - Works even when editing existing flowcharts
  - Creates completely new library entry
  - Updates current flowchart name
- **Use Cases**:
  - Creating variations of existing flowcharts
  - Branching workflows
  - Backup creation before major changes
  - Template creation from existing work

---

## üé® **User Interface**

### **1. Context Menus**
- **Description**: Right-click menus for quick node creation
- **Implementation**: `context-menus.js` - Context menu system
- **Key Features**:
  - Node type selection
  - Sample question creation
  - Empty space node creation
- **Code Location**: `context-menus.js` - Context menu handlers

### **2. Properties Menus**
- **Description**: Dynamic property configuration for each node type
- **Implementation**: `graph.js` - `showPropertiesPopup()` function
- **Key Features**:
  - Node type-specific properties
  - Real-time property updates
  - Click-outside-to-close functionality
  - Custom UI elements (search bars, buttons)

### **3. Searchable Dropdowns** ‚≠ê **NEW FEATURE**
- **Description**: Enhanced dropdowns with search functionality
- **Implementation**: `graph.js` - Custom dropdown UI system
- **Key Features**:
  - Real-time search filtering
  - Keyword-based matching (spaces/underscores)
  - Always-visible options while typing
  - Custom DOM structure for proper positioning
- **Technical Details**:
  - Replaces native `<select>` with custom `div` elements
  - `optionsContainer` with `position: absolute` for proper positioning
  - `normalizeSearchTerm()` and `matchesAllKeywords()` for robust search

### **4. Button Layout** ‚≠ê **NEW FEATURE**
- **Description**: Organized button layout with Save As functionality
- **Implementation**: `index.html` - Button structure
- **Layout** (top to bottom):
  1. **Save As** - Create new flowchart entry
  2. **Save** - Save current flowchart
  3. **Library** - View saved flowcharts
  4. **Settings** - Application settings
  5. **`<br>`** - Visual separation
  6. **Download SVG** - Export as SVG
  7. **Upload flowchart details** - Import flowchart data
  8. **Upload Document PDF** - Import PDF documents

---

## üöÄ **Advanced Features**

### **1. Hierarchical Dragging**
- **Description**: Moving parent nodes drags connected child nodes
- **Implementation**: `events.js` - `MOVE_CELLS` event handler
- **Key Features**:
  - Works for dropdown and checkbox question types
  - Recursive descendant detection
  - Maintains connection relationships
- **Code Location**: `events.js` - `getConnectedDescendants()` function

### **2. Copy-Paste Functionality**
- **Description**: Copy and paste nodes with all properties
- **Implementation**: `script.js` - Clipboard operations
- **Key Features**:
  - Preserves all custom properties
  - Handles hidden node IDs correctly
  - Prevents duplicate event listeners
- **Code Location**: `script.js` - `copySelectedNodeAsJson()` function

### **3. Zoom Functionality**
- **Description**: Mouse wheel zoom with directional control
- **Implementation**: `events.js` - Mouse wheel event handling
- **Key Features**:
  - Directional zoom towards mouse cursor
  - Smooth zoom transitions
  - Bounded zoom limits

### **4. PDF Integration**
- **Description**: PDF document integration with form generation
- **Implementation**: `generate.js` - PDF logic system
- **Key Features**:
  - PDF name inheritance
  - Conditional PDF inclusion
  - PDF pricing integration
  - Filename sanitization (removes .pdf, non-alphanumeric chars)

### **5. Form Debug Menu** ‚≠ê **NEW FEATURE**
- **Description**: Comprehensive debugging interface for form analysis
- **Implementation**: `output.html` - Debug menu system with advanced filtering
- **Key Features**:
  - **Real-time Form Analysis**: Live scanning of all form inputs, selects, and textareas
  - **Advanced Search**: Partial word matching across field names, IDs, and values
  - **Type Filtering**: Filter by input types (text, email, checkbox, radio, etc.)
  - **Virtual Checkbox Detection**: Automatically detects and displays virtual checkboxes from dropdown selections
  - **Export Functionality**: Export all field names and IDs for external analysis
  - **Click-Outside-to-Close**: Intuitive UX with automatic menu closure on overlay background clicks
  - **Clean Interface**: Filters out internal debug fields for user-friendly display
- **Technical Implementation**:
  - **Event-Driven Updates**: Real-time updates on form changes and user interactions
  - **Virtual Element Handling**: `addVirtualDropdownCheckboxes()` creates virtual entries for dropdown combinations
  - **Smart Filtering**: Excludes internal `debugTypeFilter_*` fields from display
  - **DOM Event Management**: Comprehensive event listeners for form state changes
  - **Overlay Click Detection**: Uses `event.target === debugMenu` to detect clicks on overlay background vs content area
  - **Full-Screen Overlay**: 100% width/height overlay with high z-index for proper click detection
- **Access Method**: Press `Ctrl+Shift` to open debug menu
- **Use Cases**:
  - Form validation debugging
  - Field mapping verification
  - Hidden element detection
  - Form structure analysis
  - Development and testing support

### **6. GUI JSON Generation**
- **Description**: Generate structured JSON for form applications
- **Implementation**: `library.js` - `exportGuiJson()` function
- **Key Features**:
  - Structured form data output
  - Linked fields integration
  - Conditional logic preservation
  - PDF name prefix handling

---

## üîó **Integration Features**

### **1. Firebase Authentication**
- **Description**: User authentication and data storage
- **Implementation**: Firebase integration throughout codebase
- **Key Features**:
  - User login/logout
  - Guest user support
  - Data persistence per user
  - Authentication state management

### **2. Form Generation**
- **Description**: Generate HTML forms from flowcharts
- **Implementation**: `generate.js` - Form HTML generation
- **Key Features**:
  - Dynamic form creation
  - Conditional field display
  - Validation integration
  - Responsive design

### **3. URL Parameter Support**
- **Description**: Auto-populate forms from URL parameters
- **Implementation**: `generate.js` - URL parameter parsing
- **Key Features**:
  - Automatic field population
  - URL parameter mapping
  - Form state restoration

---

## ‚úÖ **Linked Checkboxes Feature**

### **Overview**
Linked checkboxes allow you to create a single checkbox that automatically becomes checked when ANY of its linked source checkboxes are checked. This implements OR logic: if any of the source checkboxes are checked, the linked checkbox becomes checked. If all source checkboxes are unchecked, the linked checkbox becomes unchecked.

**Example**: If you have a linked checkbox called "hungry_or_thirsty" linked to "hungry_yes" and "thristy_yes", then:
- When user checks "hungry_yes" ‚Üí "hungry_or_thirsty" becomes checked
- When user checks "thristy_yes" ‚Üí "hungry_or_thirsty" becomes checked  
- When user unchecks both "hungry_yes" and "thristy_yes" ‚Üí "hungry_or_thirsty" becomes unchecked

---

### **PHASE 1: GUI Setup (gui.html / gui.js)**

#### **1.1 Opening the Linked Checkbox Modal**
**Location**: `FormWiz GUI/gui.js` - `openLinkedCheckboxModal()` function (around line 4506)

When the user clicks the "Add Linked Checkbox" button in the GUI:
```javascript
function openLinkedCheckboxModal() {
    if (!document.getElementById('linkedCheckboxModal')) {
        createLinkedCheckboxModal();
    }
    currentLinkedCheckboxConfig = [];
    document.getElementById('linkedCheckboxModal').style.display = 'block';
    const container = document.getElementById('linkedCheckboxDropdowns');
    container.innerHTML = '';
    addLinkedCheckboxDropdown();
    addLinkedCheckboxDropdown();
}
```

**What happens:**
1. Creates the modal if it doesn't exist
2. Resets `currentLinkedCheckboxConfig` array
3. Shows the modal
4. Clears any existing dropdowns
5. Adds two initial dropdowns for selecting checkbox options

#### **1.2 Creating the Modal UI**
**Location**: `FormWiz GUI/gui.js` - `createLinkedCheckboxModal()` function (around line 4518)

The modal contains:
- **Linked Checkbox ID Input**: User enters the ID for the linked checkbox (e.g., "hungry_or_thirsty")
- **Dynamic Dropdowns**: Each dropdown allows selecting a checkbox option to link
- **Link Another Button**: Adds additional dropdowns for more checkbox options
- **Done Button**: Finalizes the configuration
- **Cancel Button**: Closes the modal without saving

**Modal Structure:**
```javascript
modal.innerHTML = `
  <div style="background:#fff;margin:5% auto;padding:20px;border-radius:10px;width:80%;max-width:600px;">
    <h3>Configure Linked Checkbox</h3>
    <div id="linkedCheckboxDropdowns"></div>
    <div>
      <label>Linked Checkbox ID:</label>
      <input type="text" id="linkedCheckboxIdInput" placeholder="Enter linked Checkbox ID">
    </div>
    <button onclick="addLinkedCheckboxDropdown()">Link Another</button>
    <button onclick="finalizeLinkedCheckbox()">Done</button>
    <button onclick="closeModal()">Cancel</button>
  </div>
`;
```

#### **1.3 Populating Checkbox Options**
**Location**: `FormWiz GUI/gui.js` - `populateLinkedCheckboxDropdown()` function (around line 4562)

The system automatically finds all checkbox options in the form:

**How it works:**
1. **Searches all question blocks**: Iterates through all `[id^="questionBlock"]` elements
2. **Filters checkbox questions**: Only processes questions with `questionType === 'checkbox'`
3. **Extracts checkbox options**: Gets both:
   - Basic checkbox options: `input[id^="checkboxOptionName"]` and `input[id^="checkboxOptionText"]`
   - Unified checkbox options: `input[id^="checkboxNodeId"]` and `input[id^="checkboxText"]`
4. **Creates searchable dropdown**: Each option displays as `"Label (nodeId)"` format
5. **Builds search overlay**: Creates a searchable list that filters as user types

**Key Code:**
```javascript
const blocks = document.querySelectorAll('[id^="questionBlock"]');
blocks.forEach(block => {
    const qId = block.id.replace('questionBlock','');
    const typeSel = block.querySelector(`#questionType${qId}`);
    
    if (typeSel.value === 'checkbox') {
        // Get basic checkbox options
        const nameInputs = block.querySelectorAll(`#checkboxOptions${qId} input[id^="checkboxOptionName${qId}_"]`);
        const textInputs = block.querySelectorAll(`#checkboxOptions${qId} input[id^="checkboxOptionText${qId}_"]`);
        nameInputs.forEach((nameInput, i) => {
            const nodeId = nameInput.value.trim();
            const labelText = (textInputs[i]?.value || '').trim();
            if (nodeId) options.push({ nodeId, label: labelText || nodeId });
        });
        
        // Get unified checkbox options (for numbered dropdowns, etc.)
        const unifiedNodes = block.querySelectorAll(`input[id^="checkboxNodeId${qId}_"]`);
        const unifiedTexts = block.querySelectorAll(`input[id^="checkboxText${qId}_"]`);
        unifiedNodes.forEach((nodeInput, i) => {
            const nodeId = nodeInput.value.trim();
            const labelText = (unifiedTexts[i]?.value || '').trim();
            if (nodeId) options.push({ nodeId, label: labelText || nodeId });
        });
    }
});
```

#### **1.4 Finalizing the Configuration**
**Location**: `FormWiz GUI/gui.js` - `finalizeLinkedCheckbox()` function (around line 4637)

When user clicks "Done":
```javascript
function finalizeLinkedCheckbox(){
    const selected = currentLinkedCheckboxConfig.filter(c => c.selectedValue);
    if (selected.length < 2) { 
        alert('Please select at least 2 checkbox options to link.'); 
        return; 
    }
    const idInput = document.getElementById('linkedCheckboxIdInput');
    const linkedId = idInput ? idInput.value.trim() : '';
    if (!linkedId) { 
        alert('Please enter a Linked Checkbox ID.'); 
        return; 
    }

    createLinkedCheckboxDisplay(selected, linkedId);
    document.getElementById('linkedCheckboxModal').style.display = 'none';
}
```

**Validation:**
- Requires at least 2 checkbox options to be selected
- Requires a Linked Checkbox ID to be entered
- Creates visual display of the configuration
- Closes the modal

#### **1.5 Creating the Visual Display**
**Location**: `FormWiz GUI/gui.js` - `createLinkedCheckboxDisplay()` function (around line 4648)

Creates a visual card showing the linked checkbox configuration:
```javascript
function createLinkedCheckboxDisplay(selectedOptions, linkedId){
    const displayId = `linkedCheckbox${linkedCheckboxCounter++}`;
    // Creates a container if it doesn't exist
    let linkedFieldsContainer = document.getElementById('linkedFieldsContainer');
    if (!linkedFieldsContainer) {
        // Create container with styling
        linkedFieldsContainer = document.createElement('div');
        linkedFieldsContainer.id = 'linkedFieldsContainer';
        // Insert before form builder
        formBuilder.insertBefore(linkedFieldsContainer, formBuilder.firstChild);
    }
    
    // Create display card
    const div = document.createElement('div');
    div.id = displayId;
    const names = selectedOptions.map(s=>s.selectedValue).join(' ‚Üî ');
    div.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;">
            <div style="flex:1;">
                <h4>Linked Checkbox (${linkedId})</h4>
                <p>${names}</p>
            </div>
            <button onclick="removeLinkedCheckbox(${displayId})">Remove</button>
        </div>
    `;
    
    // Store in global config
    window.linkedCheckboxesConfig = window.linkedCheckboxesConfig || [];
    window.linkedCheckboxesConfig.push({ 
        id: displayId, 
        linkedCheckboxId: linkedId, 
        checkboxes: selectedOptions.map(s=>s.selectedValue) 
    });
}
```

**Display Format:**
- Shows: "Linked Checkbox (hungry_or_thirsty)"
- Shows: "hungry_yes ‚Üî thristy_yes"
- Includes a Remove button

**Data Storage:**
The configuration is stored in `window.linkedCheckboxesConfig` array:
```javascript
[
    {
        id: "linkedCheckbox0",
        linkedCheckboxId: "hungry_or_thirsty",
        checkboxes: ["hungry_yes", "thristy_yes"]
    }
]
```

---

### **PHASE 2: Data Processing (generate.js)**

#### **2.1 Collecting Linked Checkbox Data**
**Location**: `FormWiz GUI/generate.js` - Around line 2253-2260

When generating the form HTML, `generate.js` collects linked checkbox configurations:

```javascript
// Reset linked checkboxes array
linkedCheckboxes.length = 0;

// Collect linked checkboxes from GUI
if (window.linkedCheckboxesConfig && window.linkedCheckboxesConfig.length > 0) {
    window.linkedCheckboxesConfig.forEach(config => {
        linkedCheckboxes.push({
            linkedCheckboxId: config.linkedCheckboxId,
            checkboxes: config.checkboxes
        });
    });
}
```

**What happens:**
1. Clears the `linkedCheckboxes` array (defined at top of file: `const linkedCheckboxes = [];`)
2. Iterates through `window.linkedCheckboxesConfig` from the GUI
3. Pushes each configuration into the `linkedCheckboxes` array
4. Removes the `id` field (not needed in output)

**Result Array:**
```javascript
linkedCheckboxes = [
    {
        linkedCheckboxId: "hungry_or_thirsty",
        checkboxes: ["hungry_yes", "thristy_yes"]
    }
]
```

#### **2.2 Embedding Linked Checkbox Data in HTML**
**Location**: `FormWiz GUI/generate.js` - Around line 2395

The `linkedCheckboxes` array is embedded as a JavaScript variable in the generated HTML:

```javascript
formHTML += `var linkedCheckboxes = ${JSON.stringify(linkedCheckboxes || [])};\n`;
```

**Generated Output:**
```javascript
var linkedCheckboxes = [{"linkedCheckboxId":"hungry_or_thirsty","checkboxes":["hungry_yes","thristy_yes"]}];
```

This variable is available globally in the generated HTML and used by the runtime JavaScript.

#### **2.3 Generating Hidden Checkbox Elements**
**Location**: `FormWiz GUI/generate.js` - `generateHiddenPDFFields()` function (around line 9737-9746)

For each linked checkbox, a hidden checkbox input is generated:

```javascript
if (linkedCheckboxes && linkedCheckboxes.length > 0) {
    linkedCheckboxes.forEach(linkedCheckboxGroup => {
        const linkedCheckboxId = linkedCheckboxGroup.linkedCheckboxId;
        const checkboxIds = linkedCheckboxGroup.checkboxes || [];

        if (linkedCheckboxId && checkboxIds.length > 0) {
            hiddenFieldsHTML += `\n<div style="display:none;"><input type="checkbox" id="${linkedCheckboxId}" name="${linkedCheckboxId}"></div>`;
        }
    });
}
```

**Generated HTML:**
```html
<div style="display:none;">
    <input type="checkbox" id="hungry_or_thirsty" name="hungry_or_thirsty">
</div>
```

**Why hidden?**
- The linked checkbox is not visible to the user
- It's automatically managed by JavaScript based on source checkboxes
- It's included in form submission data

#### **2.4 Generating Runtime JavaScript**
**Location**: `FormWiz GUI/generate.js` - Around line 9541-9617

The main linked checkbox logic is generated as a `<script>` block that runs when the page loads:

```javascript
formHTML += `
  <script>
  document.addEventListener('DOMContentLoaded', function() {
    if (!linkedCheckboxes || linkedCheckboxes.length === 0) return;

    // Function to update a linked checkbox based on its source checkboxes
    function updateLinkedCheckbox(linkedCheckboxId, checkboxIds) {
      const linkedCheckbox = document.getElementById(linkedCheckboxId);
      if (!linkedCheckbox) return;

      // Check if ANY of the source checkboxes are checked (OR logic)
      let anyChecked = false;
      checkboxIds.forEach(checkboxId => {
        const sourceCheckbox = document.getElementById(checkboxId);
        if (sourceCheckbox && sourceCheckbox.checked) {
          anyChecked = true;
        }
      });

      // Update the linked checkbox state
      linkedCheckbox.checked = anyChecked;
    }

    // Set up listeners for each linked checkbox group
    linkedCheckboxes.forEach(linkedCheckboxGroup => {
      const linkedCheckboxId = linkedCheckboxGroup.linkedCheckboxId;
      const checkboxIds = linkedCheckboxGroup.checkboxes || [];

      if (!linkedCheckboxId || checkboxIds.length === 0) return;

      // Set up event listeners on each source checkbox
      checkboxIds.forEach(checkboxId => {
        const sourceCheckbox = document.getElementById(checkboxId);
        if (sourceCheckbox) {
          // Add change event listener
          sourceCheckbox.addEventListener('change', function() {
            updateLinkedCheckbox(linkedCheckboxId, checkboxIds);
          });

          // Also listen for click events
          sourceCheckbox.addEventListener('click', function() {
            setTimeout(() => {
              updateLinkedCheckbox(linkedCheckboxId, checkboxIds);
            }, 0);
          });
        }
      });

      // Initial update to set correct state
      setTimeout(() => {
        updateLinkedCheckbox(linkedCheckboxId, checkboxIds);
      }, 500);
    });

    // Global function to update all linked checkboxes (called after autofill)
    window.updateAllLinkedCheckboxes = function() {
      if (!linkedCheckboxes || linkedCheckboxes.length === 0) return;

      linkedCheckboxes.forEach(linkedCheckboxGroup => {
        const linkedCheckboxId = linkedCheckboxGroup.linkedCheckboxId;
        const checkboxIds = linkedCheckboxGroup.checkboxes || [];

        if (!linkedCheckboxId || checkboxIds.length === 0) return;

        const linkedCheckbox = document.getElementById(linkedCheckboxId);
        if (!linkedCheckbox) return;

        let anyChecked = false;
        checkboxIds.forEach(checkboxId => {
          const sourceCheckbox = document.getElementById(checkboxId);
          if (sourceCheckbox && sourceCheckbox.checked) {
            anyChecked = true;
          }
        });

        linkedCheckbox.checked = anyChecked;
      });
    };
  });
  </script>
`;
```

---

### **PHASE 3: Runtime Implementation (output.html)**

#### **3.1 Page Load Initialization**

When `output.html` loads:
1. **DOMContentLoaded Event Fires**: The script block runs after DOM is ready
2. **Checks for Linked Checkboxes**: If `linkedCheckboxes` array is empty, exits early
3. **Sets Up Event Listeners**: For each linked checkbox group, attaches listeners to all source checkboxes
4. **Initial State Check**: After 500ms delay, updates all linked checkboxes to their correct initial state

#### **3.2 The `updateLinkedCheckbox()` Function**

**Purpose**: Updates a single linked checkbox based on its source checkboxes

**Logic Flow:**
1. Gets the linked checkbox element by ID
2. If element doesn't exist, returns early
3. Loops through all source checkbox IDs
4. Checks if ANY source checkbox is checked
5. Sets linked checkbox to `true` if any source is checked, `false` if all are unchecked

**OR Logic Implementation:**
```javascript
let anyChecked = false;
checkboxIds.forEach(checkboxId => {
    const sourceCheckbox = document.getElementById(checkboxId);
    if (sourceCheckbox && sourceCheckbox.checked) {
        anyChecked = true;  // If ANY checkbox is checked, set to true
    }
});
linkedCheckbox.checked = anyChecked;
```

#### **3.3 Event Listener Setup**

For each source checkbox, two event listeners are attached:

**1. Change Event Listener:**
```javascript
sourceCheckbox.addEventListener('change', function() {
    updateLinkedCheckbox(linkedCheckboxId, checkboxIds);
});
```
- Fires when checkbox state changes (checked/unchecked)
- Immediately updates linked checkbox

**2. Click Event Listener:**
```javascript
sourceCheckbox.addEventListener('click', function() {
    setTimeout(() => {
        updateLinkedCheckbox(linkedCheckboxId, checkboxIds);
    }, 0);
});
```
- Fires on click (before change event in some cases)
- Uses `setTimeout(0)` to ensure checkbox state is updated before checking
- Provides redundancy for edge cases

#### **3.4 Initial State Update**

After setting up listeners, an initial update runs:
```javascript
setTimeout(() => {
    updateLinkedCheckbox(linkedCheckboxId, checkboxIds);
}, 500);
```

**Why 500ms delay?**
- Ensures all DOM elements are fully loaded
- Allows any autofill or other initialization to complete
- Sets correct initial state based on pre-checked checkboxes

#### **3.5 Global Update Function**

**Purpose**: `window.updateAllLinkedCheckboxes()` is called after autofill operations

**Location**: Called from autofill code in `output.html` (around line 5343)

**When it's called:**
- After Firebase autofill completes
- After URL parameter population
- After any programmatic checkbox state changes

**Implementation:**
```javascript
window.updateAllLinkedCheckboxes = function() {
    if (!linkedCheckboxes || linkedCheckboxes.length === 0) return;

    linkedCheckboxes.forEach(linkedCheckboxGroup => {
        const linkedCheckboxId = linkedCheckboxGroup.linkedCheckboxId;
        const checkboxIds = linkedCheckboxGroup.checkboxes || [];

        if (!linkedCheckboxId || checkboxIds.length === 0) return;

        const linkedCheckbox = document.getElementById(linkedCheckboxId);
        if (!linkedCheckbox) return;

        let anyChecked = false;
        checkboxIds.forEach(checkboxId => {
            const sourceCheckbox = document.getElementById(checkboxId);
            if (sourceCheckbox && sourceCheckbox.checked) {
                anyChecked = true;
            }
        });

        linkedCheckbox.checked = anyChecked;
    });
};
```

**Why it exists:**
- Autofill might set checkbox states before linked checkbox listeners are attached
- Ensures linked checkboxes are updated after any programmatic state changes
- Provides a way to manually refresh all linked checkbox states

---

### **PHASE 4: Data Persistence**

#### **4.1 Export to JSON**

**Location**: `FormWiz GUI/gui.js` - When generating GUI JSON (around line 1000-1500)

When exporting the form configuration, linked checkboxes are included in the JSON:

```json
{
  "linkedCheckboxes": [
    {
      "id": "linkedCheckbox0",
      "linkedCheckboxId": "hungry_or_thirsty",
      "checkboxes": ["hungry_yes", "thristy_yes"]
    }
  ]
}
```

**How it's collected:**
- Reads from `window.linkedCheckboxesConfig` array
- Includes all linked checkbox configurations
- Preserves the exact structure from GUI setup

#### **4.2 Import from JSON**

**Location**: `FormWiz GUI/download.js` - `loadFormData()` function (around line 1898-1908)

When importing a JSON file:
```javascript
// Load linked checkboxes
if (formData.linkedCheckboxes && formData.linkedCheckboxes.length > 0) {
    // Initialize linked checkboxes configuration
    window.linkedCheckboxesConfig = [];
    linkedCheckboxCounter = 0;
    
    formData.linkedCheckboxes.forEach(linkedCheckbox => {
        // Create the linked checkbox display
        createLinkedCheckboxDisplayFromImport(linkedCheckbox);
    });
}
```

**What happens:**
1. Checks if `linkedCheckboxes` array exists in imported data
2. Resets `window.linkedCheckboxesConfig` and counter
3. Iterates through each linked checkbox configuration
4. Calls `createLinkedCheckboxDisplayFromImport()` to recreate the visual display
5. Restores the configuration in `window.linkedCheckboxesConfig`

#### **4.3 Autosave Integration**

**Location**: `FormWiz GUI/gui.js` - Autosave functionality

Linked checkbox configurations are automatically saved:
- When user makes changes to form questions
- When linked checkbox configuration is modified
- Included in autosave data structure

**Autosave includes:**
- `window.linkedCheckboxesConfig` array
- All linked checkbox IDs and checkbox option arrays
- Visual display elements

---

### **Summary: Complete Data Flow**

1. **GUI Setup** (`gui.js`):
   - User opens modal ‚Üí selects checkbox options ‚Üí enters linked checkbox ID ‚Üí clicks Done
   - Configuration stored in `window.linkedCheckboxesConfig`
   - Visual display created in `linkedFieldsContainer`

2. **Generate.js Processing** (`generate.js`):
   - Reads from `window.linkedCheckboxesConfig`
   - Copies to `linkedCheckboxes` array
   - Embeds `linkedCheckboxes` as JavaScript variable in HTML
   - Generates hidden checkbox elements
   - Generates runtime JavaScript with event listeners

3. **Output.html Runtime** (`output.html`):
   - On page load: Sets up event listeners on source checkboxes
   - On checkbox change: Updates linked checkbox state
   - Uses OR logic: Any source checked ‚Üí linked checked, All unchecked ‚Üí linked unchecked
   - Global function available for post-autofill updates

4. **Data Persistence**:
   - Export: `window.linkedCheckboxesConfig` ‚Üí JSON `linkedCheckboxes` array
   - Import: JSON `linkedCheckboxes` ‚Üí `window.linkedCheckboxesConfig` ‚Üí Visual display
   - Autosave: Includes `window.linkedCheckboxesConfig` in autosave data

---

### **Key Technical Details**

**OR Logic:**
- The linked checkbox uses OR logic: if ANY source checkbox is checked, the linked checkbox becomes checked
- If ALL source checkboxes are unchecked, the linked checkbox becomes unchecked

**Event Handling:**
- Both `change` and `click` events are listened to for redundancy
- `setTimeout(0)` ensures state is updated before checking
- Initial update after 500ms ensures DOM is ready

**Hidden Checkbox:**
- The linked checkbox is a hidden input element
- It's included in form submission data
- It's automatically managed by JavaScript

**Global Update Function:**
- `window.updateAllLinkedCheckboxes()` is available globally
- Called after autofill operations
- Can be called manually if needed

**Multiple Linked Checkboxes:**
- Supports multiple linked checkbox groups
- Each group operates independently
- Each group can link to different sets of source checkboxes

---

### **Future Enhancement Opportunities**

1. **AND Logic Support**: Add option for AND logic (all checkboxes must be checked)
2. **Custom Logic**: Allow custom boolean expressions (e.g., "A AND (B OR C)")
3. **Visual Indicator**: Show linked checkbox state visually (even if hidden)
4. **Conditional Linking**: Only link checkboxes when certain conditions are met
5. **Nested Linking**: Allow linked checkboxes to link to other linked checkboxes

---

## üîò **Hidden Dropdown Checkboxes Feature**

### **Overview**
Hidden dropdown checkboxes automatically create hidden checkbox elements when a user selects an option from a dropdown question. When the user selects "Yes", a hidden checkbox with ID "hungry_yes" is created and checked. When they change to "No", the "hungry_yes" checkbox is removed and a new hidden checkbox "hungry_no" is created and checked. This feature allows dropdown selections to be treated as checkbox values for conditional logic, form submission, and other features that rely on checkbox state.

**Example**: For a dropdown question "Hungry?" with options "Yes" and "No":
- User selects "Yes" ‚Üí Hidden checkbox `hungry_yes` is created and checked
- User changes to "No" ‚Üí `hungry_yes` checkbox is removed, `hungry_no` checkbox is created and checked
- User clears selection ‚Üí All checkboxes are removed

**Key Benefits:**
- Dropdown selections can be used in conditional logic that checks for checkbox states
- Form submission includes checkbox data that matches dropdown selections
- Compatible with linked checkbox features
- Works with autofill from Firebase

---

### **PHASE 1: GUI Setup (gui.html / gui.js)**

#### **1.1 Creating a Dropdown Question**
**Location**: `FormWiz GUI/gui.js` - Dropdown question creation

When a user creates a dropdown question in the GUI:
1. User selects "Dropdown" as the question type
2. User adds dropdown options (e.g., "Yes", "No")
3. User can optionally set a `nameId` for the dropdown (e.g., "hungry")

**No special configuration required**: The hidden checkbox feature is automatically enabled for all dropdown questions. There's no checkbox or setting to enable/disable it - it's built into every dropdown by default.

#### **1.2 Dropdown Configuration Data**
The dropdown question stores:
- Question text (e.g., "Hungry?")
- Question type: "dropdown"
- Dropdown options array (e.g., ["Yes", "No"])
- `nameId` (optional, e.g., "hungry")

**Data Structure:**
```javascript
{
  questionId: 1,
  text: "Hungry?",
  type: "dropdown",
  options: ["Yes", "No"],
  nameId: "hungry"
}
```

---

### **PHASE 2: Data Processing (generate.js)**

#### **2.1 Generating Dropdown HTML**
**Location**: `FormWiz GUI/generate.js` - Around line 1130-1146

When generating HTML for a dropdown question, `generate.js` creates:

```javascript
// 1. The dropdown select element
formHTML += `<select id="${ddNm}" name="${ddNm}"
              onchange="dropdownMirror(this, '${ddNm}'); updateHiddenLogic('${ddNm}', this.value); updateLinkedFields(); clearInactiveLinkedFields()">
               <option value="" disabled selected>Select an option</option>`;

// 2. Add dropdown options
const ddOps = qBlock.querySelectorAll(`#dropdownOptions${questionId} input`);
for (let i = 0; i < ddOps.length; i++) {
  const val = ddOps[i].value.trim();
  if (val) {
    formHTML += `<option value="${val}">${val}</option>`;
  }
}

// 3. Create wrapper div for hidden checkboxes
formHTML += `</select><br>
      <div id="dropdowntext_${ddNm}"></div>
      <input type="text" id="${ddNm}_dropdown" name="${ddNm}_dropdown"
           readonly style="display:none;">`;
```

**Key Components:**
1. **Dropdown select**: Has `onchange` handler calling `dropdownMirror(this, '${ddNm}')`
2. **Wrapper div**: `<div id="dropdowntext_${ddNm}"></div>` - container where hidden checkboxes are placed
3. **Hidden text field**: `<input type="text" id="${ddNm}_dropdown">` - stores dropdown value as text (separate feature)

**Where `ddNm` comes from:**
- Uses `nameId` if set (e.g., "hungry")
- Otherwise uses `questionNameIds[questionId]` or `questionSlugMap[questionId]`
- Falls back to sanitized question text

#### **2.2 Generating the `dropdownMirror` Function**
**Location**: `FormWiz GUI/generate.js` - Around line 5540-5571

The `dropdownMirror` function is generated in the output HTML:

```javascript
function dropdownMirror(selectEl, baseName){
    const wrap = document.getElementById("dropdowntext_"+baseName);
    if(!wrap) return;

    const val = selectEl.value.trim();
    if(!val) {
        wrap.innerHTML = "";
        return;
    }

    const textId = baseName + "_dropdown";
    const textField = document.getElementById(textId);

    if(textField) {
        textField.value = val;
        textField.style.display = "none";
    }

    const existingCheckboxes = wrap.querySelectorAll("div");
    existingCheckboxes.forEach(div => div.remove());

    const idSuffix = val.replace(/\W+/g, "_").toLowerCase();
    const checkboxId = baseName + "_" + idSuffix;

    const checkboxDiv = document.createElement("div");
    checkboxDiv.style.display = "none";
    checkboxDiv.innerHTML = "<input type='checkbox' id='" + checkboxId + "' name='" + checkboxId + "' checked>" +
                     "<label for='" + checkboxId + "'> " + baseName + "_" + idSuffix + "</label>";

    wrap.appendChild(checkboxDiv);
    handleLinkedDropdowns(baseName, val);
}
```

**What this function does:**
1. Gets the wrapper div (`dropdowntext_${baseName}`)
2. Gets the selected dropdown value
3. If value is empty, clears the wrapper and returns
4. Updates hidden text field (separate feature)
5. **Removes all existing checkboxes** in the wrapper
6. **Creates new hidden checkbox** with ID = `${baseName}_${sanitizedValue}`
7. Sets checkbox to checked
8. Appends to wrapper div

**Checkbox ID Generation:**
- Takes dropdown value (e.g., "Yes")
- Sanitizes: `val.replace(/\W+/g, "_").toLowerCase()` ‚Üí "yes"
- Combines with base name: `baseName + "_" + idSuffix` ‚Üí "hungry_yes"

---

### **PHASE 3: Runtime Implementation (output.html)**

#### **3.1 Page Load Initialization**

When `output.html` loads:
1. All dropdowns are rendered with their options
2. The `dropdownMirror` function is available globally
3. Each dropdown has an `onchange` handler that calls `dropdownMirror`
4. If a dropdown has a pre-selected value (from autofill), the handler may not fire immediately

#### **3.2 User Selects Dropdown Option**

**When user selects an option:**
1. **Change event fires**: Dropdown's `onchange` attribute triggers
2. **`dropdownMirror` is called**: With `this` (the select element) and the dropdown's `id` (baseName)
3. **Wrapper div is found**: Gets `dropdowntext_${baseName}` container
4. **Existing checkboxes removed**: All `<div>` elements inside wrapper are removed
5. **New checkbox created**: For the newly selected value
6. **Checkbox is checked**: Automatically set to `checked = true`
7. **Appended to wrapper**: Hidden checkbox is added to the DOM

**Example Flow:**
```
User selects "Yes" from "Hungry?" dropdown (id="hungry")
  ‚Üì
dropdownMirror(selectElement, "hungry") called
  ‚Üì
val = "Yes"
  ‚Üì
idSuffix = "yes" (sanitized)
  ‚Üì
checkboxId = "hungry_yes"
  ‚Üì
Creates: <div style="display:none;">
           <input type="checkbox" id="hungry_yes" name="hungry_yes" checked>
           <label>hungry_yes</label>
         </div>
  ‚Üì
Appends to: <div id="dropdowntext_hungry"></div>
```

#### **3.3 User Changes Selection**

**When user changes from "Yes" to "No":**
1. **Old checkbox removed**: `existingCheckboxes.forEach(div => div.remove())` removes the "hungry_yes" checkbox
2. **New checkbox created**: "hungry_no" checkbox is created and checked
3. **Only one checkbox exists**: At any time, only the checkbox for the currently selected option exists

**Why remove old checkboxes?**
- Ensures only one checkbox is checked at a time (matching dropdown behavior)
- Prevents stale checkbox data from accumulating
- Keeps DOM clean and form submission data accurate

#### **3.4 User Clears Selection**

**When user clears the dropdown (returns to "Select an option"):**
1. `val = selectEl.value.trim()` returns empty string
2. `if(!val) { wrap.innerHTML = ""; return; }` executes
3. All checkboxes are removed
4. Function returns early

#### **3.5 Autofill Support**

**Location**: `FormWiz GUI/output.html` - `createHiddenCheckboxesForAutofilledDropdowns()` function (around line 6332)

When Firebase autofills dropdown values, hidden checkboxes must be created:

```javascript
function createHiddenCheckboxesForAutofilledDropdowns() {
  // Find all dropdown/select elements
  const dropdowns = document.querySelectorAll('select');

  dropdowns.forEach(dropdown => {
    if (!dropdown.id || dropdown.id.startsWith('answer')) return; // Skip numbered dropdowns

    const baseName = dropdown.id;
    const selectedValue = dropdown.value.trim();

    if (selectedValue) {
      // Generate checkbox ID using the same pattern as dropdownMirror
      const idSuffix = selectedValue.replace(/\W+/g, "_").toLowerCase();
      const checkboxId = baseName + "_" + idSuffix;
      const checkboxName = baseName + "_" + idSuffix;

      // Clear any existing hidden checkboxes for this dropdown
      const wrap = document.getElementById("dropdowntext_" + baseName);
      if (wrap) {
        while (wrap.firstChild) wrap.removeChild(wrap.firstChild);
      }

      // Check if this checkbox already exists
      const existingCheckbox = document.getElementById(checkboxId);
      if (!existingCheckbox) {
        createHiddenCheckbox(checkboxId, checkboxName, baseName);
      }

      // Handle custom hidden logic for this dropdown
      updateHiddenLogic(baseName, selectedValue);
    }
  });
```

**Helper Function `createHiddenCheckbox`:**
- **Location**: `FormWiz GUI/output.html` - Around line 6303
- Creates wrapper div if it doesn't exist
- Creates hidden checkbox div with checkbox and label
- Appends to wrapper container
- Used by `createHiddenCheckboxesForAutofilledDropdowns()` for consistency

**When it's called:**
- After Firebase autofill completes
- After URL parameter population
- After any programmatic dropdown value setting

**What it does:**
1. Finds all dropdown elements (skips numbered dropdowns that start with "answer")
2. For each dropdown with a value:
   - Generates checkbox ID using same pattern as `dropdownMirror`
   - Clears existing checkboxes in wrapper
   - Creates new hidden checkbox if it doesn't exist
   - Calls `updateHiddenLogic` for custom hidden logic

---

### **PHASE 4: Data Persistence**

#### **4.1 Export to JSON**

**Location**: `FormWiz GUI/gui.js` - When generating GUI JSON

When exporting the form configuration, dropdown questions are included:

```json
{
  "questionId": 1,
  "text": "Hungry?",
  "type": "dropdown",
  "options": ["Yes", "No"],
  "nameId": "hungry"
}
```

**Hidden checkboxes are NOT stored in JSON:**
- They are dynamically generated at runtime
- Only the dropdown configuration is stored
- Hidden checkboxes are recreated when the form loads or when user selects options

#### **4.2 Import from JSON**

**Location**: `FormWiz GUI/download.js` - `loadFormData()` function

When importing a JSON file:
1. Dropdown questions are recreated from JSON
2. Dropdown options are restored
3. Hidden checkboxes are NOT created during import
4. Hidden checkboxes are created when:
   - User selects a dropdown option
   - Autofill sets a dropdown value
   - `createHiddenCheckboxesForAutofilledDropdowns()` is called

#### **4.3 Form Submission**

**Hidden checkboxes are included in form submission:**
- When user submits the form, all hidden checkboxes are included
- Checkbox IDs follow pattern: `${dropdownName}_${optionValue}`
- Example: `hungry_yes` or `hungry_no`

**Form Data Structure:**
```
Form Data:
  hungry: "Yes"                    (dropdown value)
  hungry_dropdown: "Yes"           (hidden text field)
  hungry_yes: "on"                (hidden checkbox, only if "Yes" selected)
```

---

### **Summary: Complete Data Flow**

1. **GUI Setup** (`gui.js`):
   - User creates dropdown question with options
   - Configuration stored in question data
   - No special settings needed - feature is automatic

2. **Generate.js Processing** (`generate.js`):
   - Creates dropdown `<select>` element
   - Adds `onchange="dropdownMirror(this, '${ddNm}')"` handler
   - Creates wrapper div: `<div id="dropdowntext_${ddNm}"></div>`
   - Generates `dropdownMirror` function in output HTML

3. **Output.html Runtime** (`output.html`):
   - On dropdown change: `dropdownMirror` function executes
   - Removes old hidden checkboxes
   - Creates new hidden checkbox for selected option
   - Checkbox ID = `${dropdownName}_${sanitizedOptionValue}`
   - Checkbox is automatically checked

4. **Autofill Support**:
   - `createHiddenCheckboxesForAutofilledDropdowns()` creates checkboxes for autofilled values
   - Called after Firebase autofill completes
   - Uses same checkbox ID generation pattern

5. **Form Submission**:
   - Hidden checkboxes are included in form data
   - Only the checkbox for the currently selected option exists
   - Checkbox state matches dropdown selection

---

### **Key Technical Details**

**Checkbox ID Sanitization:**
- Option value "Yes" ‚Üí sanitized to "yes"
- Option value "No Thanks" ‚Üí sanitized to "no_thanks"
- Uses regex: `/\W+/g` to replace non-word characters with underscores
- Converts to lowercase

**Wrapper Container:**
- ID pattern: `dropdowntext_${dropdownName}`
- Contains `<div>` elements, each with a hidden checkbox
- Only one checkbox exists at a time (old ones are removed)

**Hidden Checkbox Structure:**
```html
<div style="display:none;">
  <input type="checkbox" id="hungry_yes" name="hungry_yes" checked>
  <label for="hungry_yes">hungry_yes</label>
</div>
```

**Event Handling:**
- Uses inline `onchange` attribute on `<select>` element
- Calls `dropdownMirror` immediately when selection changes
- Also calls `updateHiddenLogic`, `updateLinkedFields`, `clearInactiveLinkedFields`

**Autofill Compatibility:**
- Separate function `createHiddenCheckboxesForAutofilledDropdowns()` handles autofill
- Checks all dropdowns on page
- Creates checkboxes for any dropdowns with values
- Called after autofill completes

**Integration with Other Features:**
- **Conditional Logic**: Can check for hidden checkbox IDs (e.g., "hungry_yes")
- **Linked Checkboxes**: Hidden checkboxes can be linked to other checkboxes
- **Hidden Logic**: Works with custom hidden logic configurations
- **Form Submission**: Hidden checkboxes included in submitted data

---

### **Future Enhancement Opportunities**

1. **Multiple Selection Support**: Allow multiple checkboxes to exist simultaneously (for multi-select dropdowns)
2. **Checkbox Persistence**: Option to persist hidden checkboxes even when dropdown is cleared
3. **Custom Checkbox IDs**: Allow custom checkbox ID format instead of automatic generation
4. **Visual Indicator**: Option to show hidden checkbox state in debug mode
5. **Checkbox Unchecking**: Option to uncheck (but not remove) checkbox when dropdown is cleared

---

## ‚öôÔ∏è **Conditional Logic for Trigger Sequence Entries Feature**

### **Overview**
Conditional logic for trigger sequence entries allows dropdown fields within trigger sequences to be shown or hidden based on whether specific checkbox options are checked. When a user selects a dropdown option in a trigger sequence, it creates a hidden checkbox. Other dropdown fields in the same trigger sequence can be configured to only appear when certain hidden checkboxes (from other dropdowns or checkboxes) are checked. This implements "show if" logic: the dropdown field is hidden by default and only appears when at least one of its configured conditions is met.

**Example**: In a trigger sequence, there's a dropdown "bruh" with options "what" and "hey", and another dropdown "other dropdown" with options "yes" and "no". The "other dropdown" can be configured to only appear when "bruh_what" (the hidden checkbox created when user selects "what" from "bruh") is checked.

**Key Benefits:**
- Dynamic form behavior based on user selections within trigger sequences
- Reduces form clutter by hiding irrelevant fields
- Supports multiple conditions with OR logic (any condition met = show field)
- Works seamlessly with hidden checkboxes created by dropdown selections
- Automatically handles checkbox creation/removal when dropdown values change

---

### **PHASE 1: GUI Setup (gui.html / gui.js)**

#### **1.1 Adding Conditional Logic UI to Dropdown Fields**
**Location**: `FormWiz GUI/gui.js` - `addTriggerDropdown()` function (around line 2948)

When a dropdown field is added to a trigger sequence, the conditional logic UI is automatically included:

```javascript
function addTriggerDropdown(questionId, fieldCount, sequenceCount) {
    // ... dropdown field creation code ...
    
    // Conditional logic UI elements
    const conditionalLogicContainerId = `conditionalLogicUIDropdown${questionId}_${fieldCount}_${sequenceCount}_${triggerFieldCount}`;
    const enableConditionalLogicCheckboxId = `enableConditionalLogicDropdown${questionId}_${fieldCount}_${sequenceCount}_${triggerFieldCount}`;
    
    fieldDiv.innerHTML = `
        <!-- Dropdown field name and options UI -->
        <div style="margin-bottom: 8px; text-align: center;">
            <label for="${enableConditionalLogicCheckboxId}" style="display: block; font-weight: bold; color: #333; font-size: 12px; margin-bottom: 8px; cursor: pointer;">Enable Conditional Logic</label>
            <div style="display: flex; justify-content: center;">
                <input type="checkbox" id="${enableConditionalLogicCheckboxId}" onchange="toggleTriggerDropdownConditionalLogic(${questionId}, ${fieldCount}, ${sequenceCount}, ${triggerFieldCount})" style="cursor: pointer;">
            </div>
            <div id="${conditionalLogicContainerId}" style="margin-top: 8px; display: none;">
                <!-- Conditional logic UI will be populated here -->
            </div>
        </div>
    `;
}
```

**UI Components:**
1. **"Enable Conditional Logic" checkbox**: Toggles the conditional logic feature on/off
2. **Conditional logic container**: Initially hidden, shown when checkbox is checked
3. **Condition dropdowns**: Populated with available checkbox option IDs from the trigger sequence
4. **"Add Another Condition" button**: Allows multiple conditions (OR logic)
5. **Remove buttons (√ó)**: Remove individual conditions

#### **1.2 Toggling Conditional Logic**
**Location**: `FormWiz GUI/gui.js` - `toggleTriggerDropdownConditionalLogic()` function (around line 3748)

When the user checks/unchecks the "Enable Conditional Logic" checkbox:

```javascript
function toggleTriggerDropdownConditionalLogic(questionId, fieldCount, sequenceCount, triggerFieldCount) {
    const checkbox = document.getElementById(`enableConditionalLogicDropdown${questionId}_${fieldCount}_${sequenceCount}_${triggerFieldCount}`);
    const container = document.getElementById(`conditionalLogicUIDropdown${questionId}_${fieldCount}_${sequenceCount}_${triggerFieldCount}`);
    
    if (!checkbox || !container) return;
    
    container.style.display = checkbox.checked ? 'block' : 'none';
    
    // Initialize or update the data structure
    if (!window.triggerDropdownConditionalLogic) {
        window.triggerDropdownConditionalLogic = {};
    }
    const key = `${questionId}_${fieldCount}_${sequenceCount}_${triggerFieldCount}`;
    if (!window.triggerDropdownConditionalLogic[key]) {
        window.triggerDropdownConditionalLogic[key] = { enabled: false, conditions: [''] };
    }
    
    // Update enabled state
    window.triggerDropdownConditionalLogic[key].enabled = checkbox.checked;
    
    if (checkbox.checked) {
        updateTriggerDropdownConditionalLogicUI(questionId, fieldCount, sequenceCount, triggerFieldCount);
    } else {
        // Clear conditions when disabled
        window.triggerDropdownConditionalLogic[key].conditions = [];
    }
    
    // Trigger autosave to persist the changes
    if (typeof window.requestAutosave === 'function') {
        window.requestAutosave();
    }
}
```

**What happens:**
1. Shows/hides the conditional logic container
2. Initializes `window.triggerDropdownConditionalLogic` if it doesn't exist
3. Creates a unique key: `${questionId}_${fieldCount}_${sequenceCount}_${triggerFieldCount}`
4. Stores the enabled state and conditions array
5. If enabled, calls `updateTriggerDropdownConditionalLogicUI()` to build the UI
6. If disabled, clears the conditions array
7. Triggers autosave to persist changes

**Data Structure:**
```javascript
window.triggerDropdownConditionalLogic = {
    "2_4_1_3": {  // Key: questionId_fieldCount_sequenceCount_triggerFieldCount
        enabled: true,
        conditions: ["bruh_what"]  // Array of checkbox option IDs
    }
}
```

#### **1.3 Updating Conditional Logic UI**
**Location**: `FormWiz GUI/gui.js` - `updateTriggerDropdownConditionalLogicUI()` function (around line 3788)

This function populates the conditional logic container with dropdowns for selecting conditions:

```javascript
function updateTriggerDropdownConditionalLogicUI(questionId, fieldCount, sequenceCount, triggerFieldCount) {
    const container = document.getElementById(`conditionalLogicUIDropdown${questionId}_${fieldCount}_${sequenceCount}_${triggerFieldCount}`);
    if (!container) return;
    
    // Get available checkbox option IDs from this trigger sequence
    const checkboxNodeIds = getCheckboxOptionNodeIdsFromTriggerSequence(questionId, fieldCount, sequenceCount);
    
    const key = `${questionId}_${fieldCount}_${sequenceCount}_${triggerFieldCount}`;
    if (!window.triggerDropdownConditionalLogic[key]) {
        window.triggerDropdownConditionalLogic[key] = { enabled: true, conditions: [''] };
    }
    
    container.innerHTML = '';
    
    // Create a dropdown for each condition
    window.triggerDropdownConditionalLogic[key].conditions.forEach((condition, conditionIndex) => {
        const conditionRow = document.createElement('div');
        conditionRow.style.cssText = 'margin-bottom: 8px; display: flex; gap: 8px; align-items: center; justify-content: center; width: 100%;';
        
        // Create dropdown for selecting checkbox option
        const conditionDropdown = document.createElement('select');
        conditionDropdown.style.cssText = 'width: 70%; max-width: 300px; padding: 4px 8px; border: 1px solid #ddd; border-radius: 3px; font-size: 12px;';
        
        // Add placeholder option
        const placeholderOption = document.createElement('option');
        placeholderOption.value = '';
        placeholderOption.textContent = 'Select checkbox option...';
        conditionDropdown.appendChild(placeholderOption);
        
        // Add available checkbox options
        checkboxNodeIds.forEach(nodeId => {
            const option = document.createElement('option');
            option.value = nodeId;
            option.textContent = nodeId;
            if (condition === nodeId) {
                option.selected = true;
            }
            conditionDropdown.appendChild(option);
        });
        
        conditionDropdown.value = condition || '';
        
        // Update condition when dropdown value changes
        conditionDropdown.onchange = () => {
            if (!window.triggerDropdownConditionalLogic[key]) {
                window.triggerDropdownConditionalLogic[key] = { enabled: true, conditions: [] };
            }
            window.triggerDropdownConditionalLogic[key].conditions[conditionIndex] = conditionDropdown.value;
            // Trigger autosave
            if (typeof window.requestAutosave === 'function') {
                window.requestAutosave();
            }
        };
        
        // Remove condition button
        const removeConditionBtn = document.createElement('button');
        removeConditionBtn.textContent = '√ó';
        removeConditionBtn.style.cssText = 'background: #f44336; color: white; border: none; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; font-size: 14px;';
        removeConditionBtn.onclick = () => {
            if (window.triggerDropdownConditionalLogic[key].conditions.length > 1) {
                window.triggerDropdownConditionalLogic[key].conditions.splice(conditionIndex, 1);
                updateTriggerDropdownConditionalLogicUI(questionId, fieldCount, sequenceCount, triggerFieldCount);
                // Trigger autosave
                if (typeof window.requestAutosave === 'function') {
                    window.requestAutosave();
                }
            }
        };
        
        conditionRow.appendChild(conditionDropdown);
        conditionRow.appendChild(removeConditionBtn);
        container.appendChild(conditionRow);
    });
    
    // "Add Another Condition" button
    const addConditionBtn = document.createElement('button');
    addConditionBtn.textContent = 'Add Another Condition';
    addConditionBtn.style.cssText = 'background: #2196F3; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 11px; width: 100%; margin-top: 4px;';
    addConditionBtn.onclick = () => {
        if (!window.triggerDropdownConditionalLogic[key].conditions) {
            window.triggerDropdownConditionalLogic[key].conditions = [''];
        }
        window.triggerDropdownConditionalLogic[key].conditions.push('');
        updateTriggerDropdownConditionalLogicUI(questionId, fieldCount, sequenceCount, triggerFieldCount);
        // Trigger autosave
        if (typeof window.requestAutosave === 'function') {
            window.requestAutosave();
        }
    };
    container.appendChild(addConditionBtn);
}
```

**What this function does:**
1. Gets available checkbox option IDs from the trigger sequence using `getCheckboxOptionNodeIdsFromTriggerSequence()`
2. Creates a dropdown for each condition in the `conditions` array
3. Populates each dropdown with available checkbox option IDs
4. Sets the selected value if a condition is already configured
5. Adds change handlers to update the condition when dropdown value changes
6. Adds remove buttons (√ó) to delete individual conditions
7. Adds "Add Another Condition" button to add more conditions (OR logic)

#### **1.4 Getting Available Checkbox Option IDs**
**Location**: `FormWiz GUI/gui.js` - `getCheckboxOptionNodeIdsFromTriggerSequence()` function (around line 3537)

This function collects all checkbox option IDs available in the trigger sequence:

```javascript
function getCheckboxOptionNodeIdsFromTriggerSequence(questionId, fieldCount, sequenceCount) {
    const checkboxNodeIds = [];
    const triggerFieldsContainer = document.getElementById(`triggerFields${questionId}_${fieldCount}_${sequenceCount}`);
    
    if (!triggerFieldsContainer) return checkboxNodeIds;
    
    // Find all checkbox option node ID inputs in this trigger sequence
    const nodeIdInputs = triggerFieldsContainer.querySelectorAll('input[id^="triggerCheckboxOptionNodeId"]');
    nodeIdInputs.forEach(input => {
        const nodeId = input.value.trim();
        if (nodeId && !checkboxNodeIds.includes(nodeId)) {
            checkboxNodeIds.push(nodeId);
        }
    });
    
    // Also find dropdown fields and generate their hidden checkbox IDs
    const questionBlock = document.getElementById(`questionBlock${questionId}`);
    if (questionBlock) {
        const triggerFieldElements = triggerFieldsContainer.querySelectorAll('[class^="trigger-field-"]');
        triggerFieldElements.forEach((triggerFieldEl, triggerFieldIndex) => {
            // Check if this is a dropdown field
            const triggerDropdownFieldNameEl = triggerFieldEl.querySelector(`#triggerDropdownFieldName${questionId}_${fieldCount}_${sequenceCount}_${triggerFieldIndex + 1}`);
            
            if (triggerDropdownFieldNameEl) {
                const triggerDropdownFieldName = triggerDropdownFieldNameEl.value.trim();
                
                if (triggerDropdownFieldName) {
                    // Sanitize trigger dropdown field name
                    const sanitizedTriggerFieldName = triggerDropdownFieldName
                        .toLowerCase()
                        .replace(/[?]/g, '')
                        .replace(/[^a-z0-9_]+/g, '_')
                        .replace(/^_+|_+$/g, '');
                    
                    // Get all dropdown options
                    const triggerDropdownOptionsContainer = triggerFieldEl.querySelector(`#triggerDropdownOptions${questionId}_${fieldCount}_${sequenceCount}_${triggerFieldIndex + 1}`);
                    if (triggerDropdownOptionsContainer) {
                        const triggerOptionInputs = triggerDropdownOptionsContainer.querySelectorAll('input[type="text"]');
                        
                        triggerOptionInputs.forEach((triggerOptionInput) => {
                            const triggerOptionValue = triggerOptionInput.value.trim();
                            if (triggerOptionValue) {
                                // Sanitize option value
                                const sanitizedTriggerOptionValue = triggerOptionValue
                                    .replace(/[^A-Za-z0-9_]+/g, "_")
                                    .toLowerCase()
                                    .replace(/^_+|_+$/g, '');
                                
                                // Generate checkbox ID: {dropdownFieldName}_{optionValue}
                                // This matches the pattern used for checkbox options (no entry numbers)
                                const checkboxId = `${sanitizedTriggerFieldName}_${sanitizedTriggerOptionValue}`;
                                if (!checkboxNodeIds.includes(checkboxId)) {
                                    checkboxNodeIds.push(checkboxId);
                                }
                            }
                        });
                    }
                }
            }
        });
    }
    
    return checkboxNodeIds;
}
```

**What this function does:**
1. Finds all checkbox option node ID inputs in the trigger sequence
2. Collects their values into an array
3. Also finds dropdown fields in the trigger sequence
4. For each dropdown, generates hidden checkbox IDs in the format `{dropdownFieldName}_{optionValue}` (e.g., "bruh_what")
5. Returns all available checkbox option IDs

**Important:** For dropdown hidden checkboxes, the ID format is simplified to `{dropdownFieldName}_{optionValue}` (without entry numbers) because the conditional logic dropdown should show a single option like "bruh_what" instead of numbered options like "bruh_what_1", "bruh_what_2", etc.

---

### **PHASE 2: Data Processing (generate.js)**

#### **2.1 Collecting Conditional Logic Data**
**Location**: `FormWiz GUI/generate.js` - Around line 1660-1695

When generating HTML for trigger sequence fields, `generate.js` checks for conditional logic:

```javascript
// Inside the loop that processes trigger fields
if (dropdownFieldNameEl) {
    // ... create dropdown options ...
    
    const dropdownField = {
        type: 'dropdown',
        fieldName: dropdownFieldNameEl.value.trim(),
        options: dropdownOptions
    };
    
    // Check for conditional logic from window.triggerDropdownConditionalLogic
    const triggerFieldCount = fieldIndex + 1;
    const conditionalLogicKey = `${questionId}_${fieldOrder}_${sequenceIndex + 1}_${triggerFieldCount}`;
    
    if (window.triggerDropdownConditionalLogic && window.triggerDropdownConditionalLogic[conditionalLogicKey]) {
        const storedLogic = window.triggerDropdownConditionalLogic[conditionalLogicKey];
        
        if (storedLogic.enabled && storedLogic.conditions && storedLogic.conditions.length > 0) {
            dropdownField.conditionalLogic = {
                enabled: storedLogic.enabled,
                conditions: storedLogic.conditions.filter(c => c && c.trim() !== '')
            };
        }
    }
    
    triggerFields.push(dropdownField);
}
```

**What happens:**
1. Creates the dropdown field object with type, fieldName, and options
2. Constructs the conditional logic key: `${questionId}_${fieldOrder}_${sequenceIndex + 1}_${triggerFieldCount}`
3. Checks if conditional logic exists in `window.triggerDropdownConditionalLogic`
4. If enabled and has conditions, adds `conditionalLogic` object to the dropdown field
5. Filters out empty conditions

**Result Structure:**
```javascript
{
    type: 'dropdown',
    fieldName: 'other dropdown',
    options: [{ text: 'yes' }, { text: 'no' }],
    conditionalLogic: {
        enabled: true,
        conditions: ['bruh_what']
    }
}
```

#### **2.2 Rendering Dropdown with Conditional Logic**
**Location**: `FormWiz GUI/generate.js` - `createTriggerFieldsContainer()` function (around line 2618-2864)

When rendering the dropdown in the output HTML, conditional logic is applied:

```javascript
// Check if conditional logic is enabled
const hasConditionalLogic = triggerField.conditionalLogic && triggerField.conditionalLogic.enabled;
const conditionalConditions = hasConditionalLogic && triggerField.conditionalLogic.conditions ? triggerField.conditionalLogic.conditions : [];

// ... create dropdown select element ...

// Add conditional logic if enabled
if (hasConditionalLogic && conditionalConditions.length > 0) {
    // CRITICAL: Ensure field is hidden immediately after appending
    dropdownFieldDiv.style.display = 'none';
    
    // Function to check if any condition is met
    const checkConditionalLogic = () => {
        let anyMatch = false;
        
        // Use the parent dropdown's nodeId (same as the select.id base)
        const baseNodeIdForCheck = parentDropdownNodeId || (questionNameIds[questionId] || ('answer' + questionId));
        
        conditionalConditions.forEach((conditionNodeId) => {
            if (!conditionNodeId) return;
            
            // For dropdown hidden checkboxes, the condition is just the field name and option (e.g., "bruh_what")
            // but the actual checkbox ID includes the base nodeId: {baseNodeId}_{condition}_{entryNumber}
            const simpleCheckboxId = conditionNodeId + "_" + entryNumber;
            const fullCheckboxId = baseNodeIdForCheck + "_" + conditionNodeId + "_" + entryNumber;
            const checkboxId = fullCheckboxId; // Use the full pattern for dropdown hidden checkboxes
            const radioId = conditionNodeId + "_" + entryNumber + "_radio";
            
            // Try to find checkbox or radio button
            let checkbox = document.getElementById(checkboxId);
            if (!checkbox) {
                checkbox = document.getElementById(simpleCheckboxId);
            }
            const radio = document.getElementById(radioId);
            
            // Check if checkbox is checked or radio is selected
            if ((checkbox && checkbox.checked) || (radio && radio.checked)) {
                anyMatch = true;
                return;
            }
        });
        
        // Show or hide the dropdown field based on match
        if (anyMatch) {
            dropdownFieldDiv.style.display = 'block';
        } else {
            dropdownFieldDiv.style.display = 'none';
            // Reset dropdown value when hidden
            select.value = '';
            select.dispatchEvent(new Event('change'));
        }
    };
    
    // Set up event listeners for condition checkboxes/radios
    conditionalConditions.forEach((conditionNodeId) => {
        // ... attach listeners to checkboxes/radios ...
    });
    
    // Listen for trigger dropdown changes
    const triggerDropdownHandler = function(event) {
        const eventEntryNumber = event.detail && event.detail.entryNumber;
        const eventCheckboxId = event.detail && event.detail.checkboxId;
        
        // Re-check if checkbox was created/removed that matches our conditions
        let shouldRecheck = false;
        if (eventEntryNumber != null && String(eventEntryNumber) === String(entryNumber) && eventCheckboxId) {
            const baseNodeIdForCheck = parentDropdownNodeId || (questionNameIds[questionId] || ('answer' + questionId));
            conditionalConditions.forEach((conditionNodeId) => {
                if (!conditionNodeId) return;
                const fullCheckboxId = baseNodeIdForCheck + "_" + conditionNodeId + "_" + entryNumber;
                if (eventCheckboxId === fullCheckboxId) {
                    shouldRecheck = true;
                }
            });
        }
        
        if (shouldRecheck) {
            setTimeout(() => {
                checkConditionalLogic();
            }, 150);
        }
    };
    window.addEventListener('triggerDropdownChanged', triggerDropdownHandler);
    
    // Initial check
    setTimeout(() => {
        checkConditionalLogic();
    }, 300);
}
```

**Key Components:**
1. **Initial hiding**: Field is hidden immediately (`display: 'none'`)
2. **`checkConditionalLogic()` function**: Checks if any condition checkbox is checked
3. **Checkbox ID construction**: Uses `{baseNodeId}_{condition}_{entryNumber}` format (e.g., "is_this_plaintiff_a_business_bruh_what_1")
4. **Show/hide logic**: Shows field if any condition is met, hides if none are met
5. **Reset on hide**: Resets dropdown value when hidden
6. **Event listeners**: Listens for changes on condition checkboxes/radios
7. **`triggerDropdownChanged` listener**: Re-evaluates when dropdowns in trigger sequence change
8. **Initial check**: Runs after 300ms to set initial state

---

### **PHASE 3: Runtime Implementation (output.html)**

#### **3.1 Dropdown Change Event and Checkbox Creation**
**Location**: `FormWiz GUI/generate.js` / `output.html` - `dropdownMirror()` function (around line 3844)

When a user selects a dropdown option in a trigger sequence, `dropdownMirror` creates a hidden checkbox:

```javascript
function dropdownMirror(selectEl, baseName){
    const wrap = document.getElementById("dropdowntext_"+baseName);
    if(!wrap) return;

    const val = selectEl.value.trim();
    
    if(!val) {
        // When value is cleared, dispatch events for removed checkboxes
        const existingCheckboxes = wrap.querySelectorAll('input[type="checkbox"]');
        const removedCheckboxIds = [];
        existingCheckboxes.forEach(checkbox => {
            removedCheckboxIds.push(checkbox.id);
        });
        
        wrap.innerHTML = "";
        
        // Dispatch events for removed checkboxes
        if (removedCheckboxIds.length > 0) {
            const lastUnderscoreIndex = baseName.lastIndexOf('_');
            if (lastUnderscoreIndex !== -1) {
                const potentialEntryNumber = baseName.substring(lastUnderscoreIndex + 1);
                if (/^[0-9]+$/.test(potentialEntryNumber)) {
                    const entryNumber = parseInt(potentialEntryNumber);
                    removedCheckboxIds.forEach(checkboxId => {
                        const triggerDropdownEvent = new CustomEvent('triggerDropdownChanged', {
                            detail: {
                                entryNumber: entryNumber,
                                checkboxId: checkboxId,
                                baseName: baseName,
                                removed: true
                            }
                        });
                        window.dispatchEvent(triggerDropdownEvent);
                    });
                }
            }
        }
        return;
    }

    // ... create new checkbox ...
    
    const newCheckbox = document.getElementById(checkboxId);
    if (newCheckbox) {
        // Dispatch a change event on the newly created checkbox
        setTimeout(() => {
            const changeEvent = new Event('change', { bubbles: true });
            newCheckbox.dispatchEvent(changeEvent);
            
            // Also dispatch a custom event for trigger dropdown changes
            const lastUnderscoreIndex = baseName.lastIndexOf('_');
            if (lastUnderscoreIndex !== -1) {
                const potentialEntryNumber = baseName.substring(lastUnderscoreIndex + 1);
                if (/^[0-9]+$/.test(potentialEntryNumber)) {
                    const entryNumber = parseInt(potentialEntryNumber);
                    const triggerDropdownEvent = new CustomEvent('triggerDropdownChanged', {
                        detail: {
                            entryNumber: entryNumber,
                            checkboxId: checkboxId,
                            baseName: baseName
                        }
                    });
                    window.dispatchEvent(triggerDropdownEvent);
                }
            }
        }, 50);
    }
}
```

**What happens:**
1. When dropdown value is cleared: Removes checkboxes and dispatches `triggerDropdownChanged` events for each removed checkbox
2. When dropdown value is set: Creates new checkbox and dispatches:
   - `change` event on the checkbox itself
   - `triggerDropdownChanged` custom event with checkboxId and entryNumber

#### **3.2 Conditional Logic Re-evaluation**
**Location**: `FormWiz GUI/generate.js` / `output.html` - Conditional logic handler (around line 696-729)

The conditional logic handler listens for `triggerDropdownChanged` events:

```javascript
const triggerDropdownHandler = function(event) {
    const eventEntryNumber = event.detail && event.detail.entryNumber;
    const eventCheckboxId = event.detail && event.detail.checkboxId;
    
    // Re-check if checkbox was created/removed that matches our conditions
    let shouldRecheck = false;
    
    if (eventEntryNumber != null && String(eventEntryNumber) === String(entryNumber) && eventCheckboxId) {
        // Check if the created/removed checkbox matches any of our conditions
        const baseNodeIdForCheck = parentDropdownNodeId || (questionNameIds[questionId] || ('answer' + questionId));
        conditionalConditions.forEach((conditionNodeId) => {
            if (!conditionNodeId) return;
            const fullCheckboxId = baseNodeIdForCheck + "_" + conditionNodeId + "_" + entryNumber;
            if (eventCheckboxId === fullCheckboxId) {
                shouldRecheck = true;
            }
        });
    }
    
    if (shouldRecheck) {
        // Use a delay to ensure dropdownMirror has finished creating/removing checkboxes
        setTimeout(() => {
            checkConditionalLogic();
        }, 150);
    }
};
window.addEventListener('triggerDropdownChanged', triggerDropdownHandler);
```

**What happens:**
1. Listens for `triggerDropdownChanged` events
2. Checks if the event's `checkboxId` matches any of the conditions
3. If match found, re-evaluates `checkConditionalLogic()` after a delay
4. This ensures the dropdown field appears/disappears when relevant checkboxes are created/removed

#### **3.3 The `checkConditionalLogic()` Function**
**Location**: `FormWiz GUI/generate.js` / `output.html` - Around line 611-683

This function checks if any condition is met and shows/hides the dropdown field:

```javascript
const checkConditionalLogic = () => {
    let anyMatch = false;
    
    // Use the parent dropdown's nodeId (same as the select.id base)
    const baseNodeIdForCheck = parentDropdownNodeId || (questionNameIds[questionId] || ('answer' + questionId));
    
    conditionalConditions.forEach((conditionNodeId) => {
        if (!conditionNodeId) return;
        
        // Construct full checkbox ID: {baseNodeId}_{condition}_{entryNumber}
        const simpleCheckboxId = conditionNodeId + "_" + entryNumber;
        const fullCheckboxId = baseNodeIdForCheck + "_" + conditionNodeId + "_" + entryNumber;
        const checkboxId = fullCheckboxId; // Use the full pattern for dropdown hidden checkboxes
        const radioId = conditionNodeId + "_" + entryNumber + "_radio";
        
        // Try to find checkbox or radio button
        let checkbox = document.getElementById(checkboxId);
        if (!checkbox) {
            checkbox = document.getElementById(simpleCheckboxId);
        }
        const radio = document.getElementById(radioId);
        
        // Check if checkbox is checked or radio is selected
        if ((checkbox && checkbox.checked) || (radio && radio.checked)) {
            anyMatch = true;
            return;
        }
    });
    
    // Show or hide the dropdown field based on match
    if (anyMatch) {
        dropdownFieldDiv.style.display = 'block';
    } else {
        dropdownFieldDiv.style.display = 'none';
        // Reset dropdown value when hidden
        select.value = '';
        select.dispatchEvent(new Event('change'));
    }
};
```

**Logic Flow:**
1. Loops through each condition in `conditionalConditions` array
2. For each condition, constructs the full checkbox ID: `{baseNodeId}_{condition}_{entryNumber}`
3. Tries to find the checkbox using the full pattern, then simple pattern
4. Also checks for radio buttons (for "Mark only one" checkboxes)
5. If any checkbox is checked or radio is selected, sets `anyMatch = true`
6. Shows field if `anyMatch` is true, hides if false
7. Resets dropdown value when hidden

**OR Logic:**
- If ANY condition is met, the field is shown
- If ALL conditions are unmet, the field is hidden
- This implements OR logic: condition1 OR condition2 OR condition3 = show

---

### **PHASE 4: Data Persistence**

#### **4.1 Export to GUI JSON**
**Location**: `FormWiz GUI/download.js` - Around line 2851-2917

When exporting the form configuration, conditional logic is included in the dropdown field:

```javascript
if (dropdownFieldNameEl) {
    // ... create dropdown options ...
    
    const dropdownField = {
        type: 'dropdown',
        fieldName: dropdownFieldNameEl.value.trim(),
        options: dropdownOptions
    };
    
    // Check for conditional logic
    const enableConditionalLogicCheckbox = fieldEl.querySelector(`#enableConditionalLogicDropdown${questionId}_${fieldOrder}_${sequenceIndex + 1}_${fieldIndex + 1}`);
    const conditionalLogicEnabled = enableConditionalLogicCheckbox && enableConditionalLogicCheckbox.checked;
    
    // Include conditional logic if enabled
    if (conditionalLogicEnabled) {
        // Get conditions from the conditional logic UI
        const conditionalLogicContainer = fieldEl.querySelector(`#conditionalLogicUIDropdown${questionId}_${fieldOrder}_${sequenceIndex + 1}_${fieldIndex + 1}`);
        const conditions = [];
        
        if (conditionalLogicContainer) {
            const conditionDropdowns = conditionalLogicContainer.querySelectorAll('select');
            conditionDropdowns.forEach(dropdown => {
                const value = dropdown.value.trim();
                if (value) {
                    conditions.push(value);
                }
            });
        }
        
        // Also check window.triggerDropdownConditionalLogic for the data
        const key = `${questionId}_${fieldOrder}_${sequenceIndex + 1}_${fieldIndex + 1}`;
        if (window.triggerDropdownConditionalLogic && window.triggerDropdownConditionalLogic[key]) {
            const storedConditions = window.triggerDropdownConditionalLogic[key].conditions || [];
            // Use stored conditions if available, otherwise use dropdown values
            if (storedConditions.length > 0) {
                dropdownField.conditionalLogic = {
                    enabled: true,
                    conditions: storedConditions.filter(c => c && c.trim() !== '')
                };
            } else if (conditions.length > 0) {
                dropdownField.conditionalLogic = {
                    enabled: true,
                    conditions: conditions
                };
            }
        } else if (conditions.length > 0) {
            dropdownField.conditionalLogic = {
                enabled: true,
                conditions: conditions
            };
        }
    }
    
    triggerFields.push(dropdownField);
}
```

**Export Process:**
1. Checks if "Enable Conditional Logic" checkbox is checked
2. Gets conditions from the UI dropdowns
3. Also checks `window.triggerDropdownConditionalLogic` for stored data
4. Uses stored conditions if available, otherwise uses UI dropdown values
5. Adds `conditionalLogic` object to the dropdown field

**Exported JSON Structure:**
```json
{
    "type": "dropdown",
    "fieldName": "other dropdown",
    "options": [
        { "text": "yes" },
        { "text": "no" }
    ],
    "conditionalLogic": {
        "enabled": true,
        "conditions": ["bruh_what"]
    }
}
```

#### **4.2 Import from GUI JSON**
**Location**: `FormWiz GUI/download.js` - `loadFormData()` function (around line 1270-1342)

When importing a JSON file, conditional logic is restored:

```javascript
// Inside the loop that processes trigger fields
if (triggerField.type === 'dropdown') {
    // ... create dropdown field UI ...
    
    // Restore conditional logic if enabled
    if (triggerField.conditionalLogic && triggerField.conditionalLogic.enabled) {
        const triggerFieldCount = triggerFieldIndex + 1;
        const key = `${question.questionId}_${fieldOrder}_${sequenceIndex + 1}_${triggerFieldCount}`;
        
        if (!window.triggerDropdownConditionalLogic) {
            window.triggerDropdownConditionalLogic = {};
        }
        window.triggerDropdownConditionalLogic[key] = {
            enabled: true,
            conditions: [...(triggerField.conditionalLogic.conditions || [])]
        };
        
        setTimeout(() => {
            const enableConditionalLogicCheckbox = document.getElementById(`enableConditionalLogicDropdown${question.questionId}_${fieldOrder}_${sequenceIndex + 1}_${triggerFieldCount}`);
            if (enableConditionalLogicCheckbox) {
                enableConditionalLogicCheckbox.checked = true;
                // Trigger change event to rebuild UI
                const event = new Event('change');
                enableConditionalLogicCheckbox.dispatchEvent(event);
                
                setTimeout(() => {
                    if (triggerField.conditionalLogic.conditions && triggerField.conditionalLogic.conditions.length > 0) {
                        // Update UI with conditions
                        if (typeof updateTriggerDropdownConditionalLogicUI === 'function') {
                            updateTriggerDropdownConditionalLogicUI(question.questionId, fieldOrder, sequenceIndex + 1, triggerFieldCount);
                            
                            setTimeout(() => {
                                // Set condition dropdown values
                                triggerField.conditionalLogic.conditions.forEach((condition, condIndex) => {
                                    if (condIndex > 0) {
                                        // Click "Add Another Condition" button for additional conditions
                                        const addConditionBtn = document.querySelector(`#conditionalLogicUIDropdown${question.questionId}_${fieldOrder}_${sequenceIndex + 1}_${triggerFieldCount} button`);
                                        if (addConditionBtn && addConditionBtn.textContent === 'Add Another Condition') {
                                            addConditionBtn.click();
                                        }
                                    }
                                    
                                    setTimeout(() => {
                                        const conditionDropdown = document.querySelector(`#conditionalLogicUIDropdown${question.questionId}_${fieldOrder}_${sequenceIndex + 1}_${triggerFieldCount} select:nth-of-type(${condIndex + 1})`);
                                        if (conditionDropdown) {
                                            conditionDropdown.value = condition;
                                            conditionDropdown.dispatchEvent(new Event('change'));
                                        }
                                    }, 150 * (condIndex + 1));
                                });
                            }, 300);
                        }
                    }
                }, 400);
            }
        }, 200);
    }
}
```

**Import Process:**
1. Checks if `conditionalLogic` exists and is enabled in the imported data
2. Initializes `window.triggerDropdownConditionalLogic` if needed
3. Stores the conditions in the data structure
4. Checks the "Enable Conditional Logic" checkbox
5. Triggers change event to rebuild the UI
6. Calls `updateTriggerDropdownConditionalLogicUI()` to populate dropdowns
7. Sets each condition dropdown value
8. Clicks "Add Another Condition" button for additional conditions

#### **4.3 Autosave Integration**
**Location**: `FormWiz GUI/gui.js` - Autosave functionality

Conditional logic configurations are automatically saved:
- When user checks/unchecks "Enable Conditional Logic" checkbox
- When user changes condition dropdown values
- When user adds/removes conditions
- Included in autosave data structure

**Autosave includes:**
- `window.triggerDropdownConditionalLogic` object
- All enabled states and conditions arrays
- Preserved across page reloads

---

### **Summary: Complete Data Flow**

1. **GUI Setup** (`gui.js`):
   - User adds dropdown to trigger sequence
   - User checks "Enable Conditional Logic" checkbox
   - User selects checkbox options from dropdown
   - User can add multiple conditions (OR logic)
   - Configuration stored in `window.triggerDropdownConditionalLogic`

2. **Generate.js Processing** (`generate.js`):
   - Reads from `window.triggerDropdownConditionalLogic`
   - Adds `conditionalLogic` object to dropdown field
   - Generates HTML with conditional logic handlers
   - Sets up event listeners for condition checkboxes
   - Sets up `triggerDropdownChanged` event listener

3. **Output.html Runtime** (`output.html`):
   - Field is hidden by default
   - `checkConditionalLogic()` runs on page load
   - When user selects dropdown option, `dropdownMirror` creates checkbox
   - `dropdownMirror` dispatches `triggerDropdownChanged` event
   - Conditional logic handler re-evaluates
   - Field appears if condition is met, disappears if not
   - When user changes dropdown value, old checkbox removed, new one created
   - Conditional logic re-evaluates again

4. **Data Persistence**:
   - Export: `window.triggerDropdownConditionalLogic` ‚Üí JSON `conditionalLogic` object
   - Import: JSON `conditionalLogic` ‚Üí `window.triggerDropdownConditionalLogic` ‚Üí UI restoration
   - Autosave: Includes `window.triggerDropdownConditionalLogic` in autosave data

---

### **Key Technical Details**

**Conditional Logic Key Format:**
- Pattern: `${questionId}_${fieldCount}_${sequenceCount}_${triggerFieldCount}`
- Example: `"2_4_1_3"` = Question 2, Field 4, Sequence 1, Trigger Field 3
- Used to uniquely identify each dropdown field's conditional logic configuration

**Checkbox ID Construction:**
- Condition format in UI: `{dropdownFieldName}_{optionValue}` (e.g., "bruh_what")
- Actual checkbox ID at runtime: `{baseNodeId}_{condition}_{entryNumber}` (e.g., "is_this_plaintiff_a_business_bruh_what_1")
- The `baseNodeId` is the parent dropdown's nodeId (trigger title)
- The `entryNumber` is the entry number from the numbered dropdown

**Event System:**
- `triggerDropdownChanged` custom event is dispatched when:
  - Dropdown value changes (creates/removes checkboxes)
  - Checkbox is created by `dropdownMirror`
  - Checkbox is removed when dropdown is cleared
- Event detail includes: `entryNumber`, `checkboxId`, `baseName`
- Conditional logic handlers listen for this event and re-evaluate

**OR Logic Implementation:**
- Multiple conditions in `conditions` array = OR logic
- If ANY condition is met, field is shown
- If ALL conditions are unmet, field is hidden
- Each condition is checked independently

**Initial State:**
- Field is hidden by default (`display: 'none'`)
- `checkConditionalLogic()` runs after 300ms delay
- Ensures DOM is ready and checkboxes may have been created by autofill

**Reset on Hide:**
- When field is hidden, dropdown value is reset to empty
- `change` event is dispatched to trigger `dropdownMirror`
- This ensures any dependent logic is also reset

---

### **Future Enhancement Opportunities**

1. **AND Logic Support**: Add option for AND logic (all conditions must be met)
2. **Custom Logic Expressions**: Allow custom boolean expressions (e.g., "(A OR B) AND C")
3. **Visual Indicators**: Show which conditions are currently met in debug mode
4. **Condition Groups**: Support grouping conditions with different logic (e.g., "(A OR B) AND (C OR D)")
5. **Conditional Logic for Other Field Types**: Extend to labels, checkboxes, dates, PDFs, locations
6. **Nested Conditions**: Allow conditions to reference other conditional fields
7. **Conditional Logic Builder UI**: Visual builder for complex conditional logic

---

## üìã **Add Dropdown Field Feature in Numbered Dropdown Questions**

### **Overview**
The "Add Dropdown" feature allows users to add dropdown fields within numbered dropdown questions. These dropdown fields appear for each entry created by the numbered dropdown (e.g., if user selects "3" from "How many cars?", the dropdown field appears 3 times, once for each car entry). Dropdown fields can have multiple options, trigger sequences (conditional fields that appear based on dropdown selection), and conditional logic (show/hide based on checkbox states).

**Example**: In a numbered dropdown question "How many cars?" with range 1-3:
- User adds a dropdown field "Is this car a Toyota?" with options "Yes" and "No"
- User adds a trigger sequence: When "Yes" is selected, show a date field "When did you buy it?"
- When user selects "2" from the numbered dropdown, two entry containers are created
- Each entry container contains the "Is this car a Toyota?" dropdown
- When user selects "Yes" in entry 1, the date field "When did you buy it?" appears for entry 1 only

**Key Benefits:**
- Dynamic form generation based on user selection
- Conditional field display within entries
- Support for complex nested logic
- Full integration with export/import and autosave

---

### **PHASE 1: GUI Setup (gui.html / gui.js)**

#### **1.1 Adding a Dropdown Field**
**Location**: `FormWiz GUI/gui.js` - `addDropdownField()` function (around line 2810)

When the user clicks the "Add Dropdown" button in a numbered dropdown question:

```javascript
function addDropdownField(questionId) {
    const unifiedDiv = getUnifiedContainer(questionId);
    
    // Ensure the unified container is visible
    if (unifiedDiv.style.display === 'none') {
        unifiedDiv.style.display = 'block';
    }
    
    const fieldCount = unifiedDiv.children.length + 1;
    
    const fieldDiv = document.createElement('div');
    fieldDiv.className = `unified-field field-${fieldCount}`;
    fieldDiv.setAttribute('data-type', 'dropdown');
    fieldDiv.setAttribute('data-order', fieldCount);
    
    // Create the dropdown field UI
    fieldDiv.innerHTML = `
        <div style="...">
            <div>Dropdown Field</div>
            
            <!-- Field Name Input -->
            <input type="text" id="dropdownFieldName${questionId}_${fieldCount}" 
                   placeholder="Enter dropdown field name">
            
            <!-- Add Options Section -->
            <div id="dropdownOptions${questionId}_${fieldCount}">
                <!-- Options will be added here -->
            </div>
            <button onclick="addDropdownOption(${questionId}, ${fieldCount})">
                Add dropdown option
            </button>
            
            <!-- Conditional Logic Section -->
            <div id="triggerSequences${questionId}_${fieldCount}">
                <!-- Trigger sequences will be added here -->
            </div>
            <button onclick="addTriggerSequence(${questionId}, ${fieldCount})">
                Add trigger
            </button>
            
            <button onclick="removeUnifiedField(${questionId}, ${fieldCount})">
                Remove
            </button>
        </div>
    `;
    
    unifiedDiv.appendChild(fieldDiv);
}
```

**What happens:**
1. Gets the unified fields container for the question
2. Makes the container visible if hidden
3. Calculates the next field order number
4. Creates a new unified field div with `data-type="dropdown"` and `data-order` attribute
5. Creates UI for:
   - Field name input
   - Options container (initially empty)
   - "Add dropdown option" button
   - Trigger sequences container (initially empty)
   - "Add trigger" button
   - Remove button

**Data Structure:**
- Each dropdown field is stored as a unified field with:
  - `data-type="dropdown"` - Identifies it as a dropdown field
  - `data-order={fieldCount}` - Preserves creation order
  - Field name stored in `#dropdownFieldName${questionId}_${fieldCount}` input

#### **1.2 Adding Dropdown Options**
**Location**: `FormWiz GUI/gui.js` - `addDropdownOption()` function (around line 2909)

When the user clicks "Add dropdown option":

```javascript
function addDropdownOption(questionId, fieldCount) {
    const optionsContainer = document.getElementById(`dropdownOptions${questionId}_${fieldCount}`);
    const optionCount = optionsContainer.children.length + 1;
    
    const optionDiv = document.createElement('div');
    optionDiv.className = `dropdown-option-${optionCount}`;
    optionDiv.innerHTML = `
        <label>Option text:</label>
        <input type="text" id="dropdownOptionText${questionId}_${fieldCount}_${optionCount}" 
               placeholder="Enter option text">
        
        <label>Option Node ID:</label>
        <input type="text" id="dropdownOptionNodeId${questionId}_${fieldCount}_${optionCount}" 
               placeholder="Enter option node ID">
        
        <button onclick="removeDropdownOption(${questionId}, ${fieldCount}, ${optionCount})">
            Remove Option
        </button>
    `;
    
    optionsContainer.appendChild(optionDiv);
    
    // Update trigger condition options for all trigger sequences
    const triggerSequencesContainer = document.getElementById(`triggerSequences${questionId}_${fieldCount}`);
    if (triggerSequencesContainer) {
        const sequenceElements = triggerSequencesContainer.querySelectorAll('[class^="trigger-sequence-"]');
        sequenceElements.forEach((sequenceEl, sequenceIndex) => {
            updateTriggerConditionOptions(questionId, fieldCount, sequenceIndex + 1);
        });
    }
}
```

**What happens:**
1. Gets the options container for this dropdown field
2. Calculates the next option number
3. Creates an option div with:
   - Option text input
   - Option Node ID input
   - Remove button
4. Appends to options container
5. Updates trigger condition dropdowns (so new options appear in trigger sequence conditions)

**Option Data Structure:**
- Each option has:
  - `text` - Display text (from `dropdownOptionText` input)
  - `nodeId` - Unique identifier (from `dropdownOptionNodeId` input)

#### **1.3 Adding Trigger Sequences**
**Location**: `FormWiz GUI/gui.js` - `addTriggerSequence()` function (around line 2990)

When the user clicks "Add trigger":

```javascript
function addTriggerSequence(questionId, fieldCount) {
    const triggerSequencesContainer = document.getElementById(`triggerSequences${questionId}_${fieldCount}`);
    const sequenceCount = triggerSequencesContainer.children.length + 1;
    
    const sequenceDiv = document.createElement('div');
    sequenceDiv.className = `trigger-sequence-${sequenceCount}`;
    sequenceDiv.innerHTML = `
        <div>Trigger Sequence ${sequenceCount}</div>
        
        <!-- Trigger Condition Dropdown -->
        <label>When this option is selected:</label>
        <select id="triggerCondition${questionId}_${fieldCount}_${sequenceCount}">
            <!-- Options populated dynamically -->
        </select>
        
        <!-- Trigger Title Input -->
        <label>Title for additional fields:</label>
        <input type="text" id="triggerTitle${questionId}_${fieldCount}_${sequenceCount}" 
               value="Additional Information">
        
        <!-- Trigger Fields Container -->
        <div id="triggerFields${questionId}_${fieldCount}_${sequenceCount}">
            <!-- Fields will be added here -->
        </div>
        
        <button onclick="addTriggerLabel(...)">Add Label</button>
        <button onclick="addTriggerCheckbox(...)">Add Checkbox</button>
        <button onclick="addTriggerDropdown(...)">Add Dropdown</button>
        <button onclick="addTriggerDate(...)">Add Date</button>
        <!-- ... other field type buttons ... -->
        
        <button onclick="removeTriggerSequence(...)">Remove Sequence</button>
    `;
    
    triggerSequencesContainer.appendChild(sequenceDiv);
    
    // Populate trigger condition options
    updateTriggerConditionOptions(questionId, fieldCount, sequenceCount);
}
```

**What happens:**
1. Gets the trigger sequences container
2. Calculates the next sequence number
3. Creates a sequence div with:
   - Trigger condition dropdown (populated with dropdown options)
   - Trigger title input (default: "Additional Information")
   - Trigger fields container (for conditional fields)
   - Buttons to add different field types
   - Remove button
4. Populates the trigger condition dropdown with available options

**Trigger Sequence Data Structure:**
- Each sequence has:
  - `condition` - The dropdown option value that triggers this sequence
  - `title` - Title shown above the conditional fields
  - `fields` - Array of fields that appear when condition is met

---

### **PHASE 2: Data Processing (generate.js)**

#### **2.1 Collecting Dropdown Field Data**
**Location**: `FormWiz GUI/generate.js` - Around line 1654-1912

When generating HTML, `generate.js` processes unified fields:

```javascript
// Process unified fields
unifiedFields.forEach((field) => {
    const fieldType = field.getAttribute('data-type');
    const fieldOrder = field.getAttribute('data-order');
    
    if (fieldType === 'dropdown') {
        const fieldNameEl = field.querySelector('#dropdownFieldName' + questionId + '_' + fieldOrder);
        const optionsContainer = field.querySelector('#dropdownOptions' + questionId + '_' + fieldOrder);
        const triggerSequencesContainer = field.querySelector('#triggerSequences' + questionId + '_' + fieldOrder);
        
        if (fieldNameEl) {
            // Collect dropdown options
            const dropdownOptions = [];
            if (optionsContainer) {
                const optionElements = optionsContainer.querySelectorAll('[class^="dropdown-option-"]');
                optionElements.forEach((optionEl, optionIndex) => {
                    const textEl = optionEl.querySelector('#dropdownOptionText' + questionId + '_' + fieldOrder + '_' + (optionIndex + 1));
                    const nodeIdEl = optionEl.querySelector('#dropdownOptionNodeId' + questionId + '_' + fieldOrder + '_' + (optionIndex + 1));
                    
                    if (textEl && nodeIdEl) {
                        dropdownOptions.push({
                            text: textEl.value.trim(),
                            nodeId: nodeIdEl.value.trim()
                        });
                    }
                });
            }
            
            // Collect trigger sequences
            const triggerSequences = [];
            if (triggerSequencesContainer) {
                const sequenceElements = triggerSequencesContainer.querySelectorAll('[class^="trigger-sequence-"]');
                sequenceElements.forEach((sequenceEl, sequenceIndex) => {
                    const triggerConditionEl = sequenceEl.querySelector('#triggerCondition' + questionId + '_' + fieldOrder + '_' + (sequenceIndex + 1));
                    const triggerFieldsContainer = sequenceEl.querySelector('#triggerFields' + questionId + '_' + fieldOrder + '_' + (sequenceIndex + 1));
                    
                    const triggerFields = [];
                    // ... collect trigger fields (labels, checkboxes, dropdowns, dates, etc.) ...
                    
                    const triggerTitleEl = sequenceEl.querySelector('#triggerTitle' + questionId + '_' + fieldOrder + '_' + (sequenceIndex + 1));
                    const triggerTitle = triggerTitleEl ? (triggerTitleEl.value.trim() || 'Additional Information') : 'Additional Information';
                    
                    triggerSequences.push({
                        condition: triggerConditionEl ? triggerConditionEl.value.trim() : '',
                        title: triggerTitle,
                        fields: triggerFields
                    });
                });
            }
            
            allElements.push({
                type: fieldType,
                fieldName: fieldNameEl.value.trim(),
                options: dropdownOptions,
                triggerSequences: triggerSequences,
                order: parseInt(fieldOrder)
            });
        }
    }
});
```

**What happens:**
1. Iterates through all unified fields
2. For dropdown fields:
   - Gets field name from input
   - Collects all dropdown options (text and nodeId)
   - Collects all trigger sequences with their conditions, titles, and fields
3. Adds to `allFieldsInOrder` array sorted by `order` attribute

**Result Structure:**
```javascript
{
    type: 'dropdown',
    fieldName: 'Is this car a Toyota?',
    options: [
        { text: 'Yes', nodeId: 'is_this_car_a_toyota_yes' },
        { text: 'No', nodeId: 'is_this_car_a_toyota_no' }
    ],
    triggerSequences: [
        {
            condition: 'Yes',
            title: 'Additional Information',
            fields: [
                { type: 'date', label: 'When did you buy it?', nodeId: 'is_this_car_a_toyota_yes_when_did_you_buy_it' }
            ]
        }
    ],
    order: 2
}
```

#### **2.2 Storing in unifiedFieldsMap**
**Location**: `FormWiz GUI/generate.js` - Around line 1982-1984

The dropdown field data is stored in `window.unifiedFieldsMap`:

```javascript
window.unifiedFieldsMap = window.unifiedFieldsMap || {};
window.unifiedFieldsMap[questionId] = allFieldsInOrder;
```

This map is embedded in the generated HTML as a JavaScript variable for runtime use.

#### **2.3 Embedding in Generated HTML**
**Location**: `FormWiz GUI/generate.js` - Around line 3918-3921

The `unifiedFieldsMap` is embedded as a JavaScript variable:

```javascript
formHTML += `var unifiedFieldsMap = ${JSON.stringify(window.unifiedFieldsMap || {})};\n`;
```

**Generated Output:**
```javascript
var unifiedFieldsMap = {
    "1": [
        {
            "type": "label",
            "label": "Name",
            "nodeId": "how_many_cars_name",
            "order": 1
        },
        {
            "type": "dropdown",
            "fieldName": "Is this car a Toyota?",
            "options": [
                { "text": "Yes", "nodeId": "is_this_car_a_toyota_yes" },
                { "text": "No", "nodeId": "is_this_car_a_toyota_no" }
            ],
            "triggerSequences": [
                {
                    "condition": "Yes",
                    "title": "Additional Information",
                    "fields": [
                        {
                            "type": "date",
                            "label": "When did you buy it?",
                            "nodeId": "is_this_car_a_toyota_yes_when_did_you_buy_it"
                        }
                    ]
                }
            ],
            "order": 2
        }
    ]
};
```

---

### **PHASE 3: Runtime Implementation (output.html)**

#### **3.1 Rendering Dropdown Fields**
**Location**: `FormWiz GUI/generate.js` - `showTextboxLabels()` function (around line 5962-6110)

When the user selects a number from the numbered dropdown, `showTextboxLabels()` is called:

```javascript
function showTextboxLabels(questionId, count) {
    const container = document.getElementById("labelContainer" + questionId);
    container.innerHTML = "";
    
    // Get all fields in order from unifiedFieldsMap
    const allFieldsInOrder = window.unifiedFieldsMap[questionId] || [];
    
    // Generate entries for the selected count
    for(let j = 1; j <= count; j++) {
        const entryContainer = document.createElement('div');
        entryContainer.className = 'entry-container';
        
        // Process all fields in creation order
        for(let fieldIndex = 0; fieldIndex < allFieldsInOrder.length; fieldIndex++) {
            const field = allFieldsInOrder[fieldIndex];
            
            if (field.type === 'dropdown') {
                // Create dropdown field div
                const dropdownFieldDiv = document.createElement('div');
                dropdownFieldDiv.style.cssText = 'margin: 15px 0; padding: 20px; border: 2px solid #2196F3; ...';
                
                // Add field name as label
                const fieldNameLabel = document.createElement('h4');
                fieldNameLabel.textContent = field.fieldName;
                dropdownFieldDiv.appendChild(fieldNameLabel);
                
                // Create dropdown select element
                const select = document.createElement('select');
                const sanitizedFieldName = field.fieldName
                    .toLowerCase()
                    .replace(/[?]/g, '')
                    .replace(/[^a-z0-9_]+/g, '_')
                    .replace(/^_+|_+$/g, '');
                select.id = sanitizedFieldName + "_" + j;
                select.name = select.id;
                
                // Add placeholder option
                const placeholderOption = document.createElement('option');
                placeholderOption.value = '';
                placeholderOption.textContent = 'Select an option...';
                placeholderOption.disabled = true;
                placeholderOption.selected = true;
                select.appendChild(placeholderOption);
                
                // Add dropdown options
                const dropdownOptions = field.options || [];
                dropdownOptions.forEach((option) => {
                    const optionElement = document.createElement('option');
                    optionElement.value = option.text;
                    optionElement.textContent = option.text;
                    optionElement.setAttribute('data-node-id', option.nodeId);
                    select.appendChild(optionElement);
                });
                
                // Handle trigger sequences
                if (field.triggerSequences && field.triggerSequences.length > 0) {
                    // ... create trigger sequence containers and fields ...
                }
                
                dropdownFieldDiv.appendChild(select);
                entryContainer.appendChild(dropdownFieldDiv);
            }
        }
        
        container.appendChild(entryContainer);
    }
}
```

**What happens:**
1. Clears the label container
2. Gets `allFieldsInOrder` from `unifiedFieldsMap[questionId]`
3. For each entry (1 to count):
   - Creates an entry container div
   - Processes all fields in order
   - For dropdown fields:
     - Creates a styled dropdown field div
     - Adds field name as heading
     - Creates `<select>` element with sanitized ID: `{sanitizedFieldName}_{entryNumber}`
     - Adds placeholder option
     - Adds all dropdown options
     - Sets up trigger sequence handling
   - Appends entry container to label container

**Dropdown ID Format:**
- Field name: "Is this car a Toyota?"
- Sanitized: "is_this_car_a_toyota"
- Entry 1: `is_this_car_a_toyota_1`
- Entry 2: `is_this_car_a_toyota_2`

#### **3.2 Trigger Sequence Handling**
**Location**: `FormWiz GUI/generate.js` - Around line 6099-6110

When a dropdown option is selected, trigger sequences are evaluated:

```javascript
// Handle trigger sequences
if (field.triggerSequences && field.triggerSequences.length > 0) {
    field.triggerSequences.forEach((sequence, sequenceIndex) => {
        // Create trigger fields container (initially hidden)
        const triggerFieldsContainer = document.createElement('div');
        triggerFieldsContainer.id = 'triggerFields_' + questionId + '_' + j + '_' + sequenceIndex;
        triggerFieldsContainer.style.display = 'none';
        
        // Add trigger title
        const triggerTitle = document.createElement('h5');
        triggerTitle.textContent = sequence.title || 'Additional Information';
        triggerFieldsContainer.appendChild(triggerTitle);
        
        // Add trigger fields
        if (sequence.fields && sequence.fields.length > 0) {
            sequence.fields.forEach((triggerField) => {
                // Create field based on type (label, checkbox, dropdown, date, etc.)
                // ... field creation logic ...
            });
        }
        
        // Set up change handler
        select.addEventListener('change', function() {
            const selectedValue = this.value;
            if (sequence.condition === selectedValue) {
                triggerFieldsContainer.style.display = 'block';
            } else {
                triggerFieldsContainer.style.display = 'none';
                // Reset fields when hidden
                resetTriggerSequenceFields(triggerFieldsContainer);
            }
        });
        
        dropdownFieldDiv.appendChild(triggerFieldsContainer);
    });
}
```

**What happens:**
1. For each trigger sequence:
   - Creates a trigger fields container (initially hidden)
   - Adds trigger title
   - Creates all trigger fields (labels, checkboxes, dropdowns, dates, etc.)
2. Sets up change event listener on the dropdown:
   - When selected value matches sequence condition ‚Üí show container
   - When selected value doesn't match ‚Üí hide container and reset fields

**Trigger Sequence Logic:**
- Only one trigger sequence can be active at a time (based on selected dropdown value)
- When dropdown value changes, old trigger sequence is hidden, new one is shown
- Fields in hidden trigger sequences are reset to prevent stale data

#### **3.3 Dropdown Change Events**
**Location**: `FormWiz GUI/generate.js` - Around line 6093-6095

When a dropdown option is selected:

```javascript
select.addEventListener('change', function() {
    const selectedValue = this.value;
    const selectedOption = this.options[this.selectedIndex];
    const nodeId = selectedOption ? selectedOption.getAttribute('data-node-id') : '';
    
    // Handle trigger sequences
    // ... show/hide trigger fields based on condition ...
    
    // Call dropdownMirror to create hidden checkbox
    if (typeof dropdownMirror === 'function') {
        dropdownMirror(this, this.id);
    }
    
    // Update hidden logic if needed
    if (typeof updateHiddenLogic === 'function') {
        updateHiddenLogic(this.id, selectedValue);
    }
});
```

**What happens:**
1. Gets selected value and nodeId
2. Evaluates trigger sequences (show/hide conditional fields)
3. Calls `dropdownMirror()` to create hidden checkbox (see Hidden Dropdown Checkboxes feature)
4. Calls `updateHiddenLogic()` for custom hidden logic

---

### **PHASE 4: Data Persistence**

#### **4.1 Export to JSON**
**Location**: `FormWiz GUI/download.js` - `exportForm()` function (around line 3850-4000)

When exporting the form configuration:

```javascript
// Process unified fields
unifiedFields.forEach((el) => {
    const fieldType = el.getAttribute('data-type');
    const fieldOrder = parseInt(el.getAttribute('data-order'));
    
    if (fieldType === 'dropdown') {
        const fieldNameEl = el.querySelector('#dropdownFieldName' + questionId + '_' + fieldOrder);
        const optionsContainer = el.querySelector('#dropdownOptions' + questionId + '_' + fieldOrder);
        const triggerSequencesContainer = el.querySelector('#triggerSequences' + questionId + '_' + fieldOrder);
        
        if (fieldNameEl) {
            // Collect dropdown options
            const dropdownOptions = [];
            // ... collect options ...
            
            // Collect trigger sequences
            const triggerSequences = [];
            // ... collect trigger sequences ...
            
            allFieldsInOrder.push({
                type: 'dropdown',
                fieldName: fieldNameEl.value.trim(),
                options: dropdownOptions,
                triggerSequences: triggerSequences,
                order: fieldOrder
            });
        }
    }
});

// Add to question's allFieldsInOrder
question.allFieldsInOrder = allFieldsInOrder;
```

**Exported JSON Structure:**
```json
{
    "questionId": 1,
    "text": "How many cars",
    "type": "numberedDropdown",
    "allFieldsInOrder": [
        {
            "type": "label",
            "label": "Name",
            "nodeId": "how_many_cars_name",
            "order": 1
        },
        {
            "type": "dropdown",
            "fieldName": "Is this car a Toyota?",
            "options": [
                {
                    "text": "Yes",
                    "nodeId": "is_this_car_a_toyota_yes"
                },
                {
                    "text": "No",
                    "nodeId": "is_this_car_a_toyota_no"
                }
            ],
            "triggerSequences": [
                {
                    "condition": "Yes",
                    "title": "Additional Information",
                    "fields": [
                        {
                            "type": "date",
                            "label": "When did you buy it?",
                            "nodeId": "is_this_car_a_toyota_yes_when_did_you_buy_it"
                        }
                    ]
                }
            ],
            "order": 2
        }
    ]
}
```

#### **4.2 Import from JSON**
**Location**: `FormWiz GUI/download.js` - `loadFormData()` function (around line 626-800)

When importing a JSON file:

```javascript
// Process allFieldsInOrder
if (question.allFieldsInOrder && question.allFieldsInOrder.length > 0) {
    question.allFieldsInOrder.forEach((field) => {
        if (field.type === 'dropdown') {
            // Check if addDropdownField function is available
            if (typeof addDropdownField !== 'function') {
                console.error('addDropdownField function not available!');
                return;
            }
            
            // Add a dropdown field
            addDropdownField(question.questionId);
            
            // Set the field values
            const lastField = unifiedFieldsDiv.lastElementChild;
            if (lastField) {
                const fieldOrder = lastField.getAttribute('data-order');
                const fieldNameEl = lastField.querySelector('#dropdownFieldName' + question.questionId + '_' + fieldOrder);
                
                if (fieldNameEl && field.fieldName) {
                    fieldNameEl.value = field.fieldName;
                }
                
                // Add dropdown options
                if (field.options && field.options.length > 0) {
                    field.options.forEach((option, optionIndex) => {
                        addDropdownOption(question.questionId, fieldOrder);
                        
                        // Set the option values
                        const optionTextEl = document.getElementById('dropdownOptionText' + question.questionId + '_' + fieldOrder + '_' + (optionIndex + 1));
                        const optionNodeIdEl = document.getElementById('dropdownOptionNodeId' + question.questionId + '_' + fieldOrder + '_' + (optionIndex + 1));
                        
                        if (optionTextEl) optionTextEl.value = option.text;
                        if (optionNodeIdEl) optionNodeIdEl.value = option.nodeId;
                    });
                }
                
                // Add trigger sequences
                if (field.triggerSequences && field.triggerSequences.length > 0) {
                    field.triggerSequences.forEach((sequence, sequenceIndex) => {
                        addTriggerSequence(question.questionId, fieldOrder);
                        
                        // Set trigger condition and title
                        const triggerConditionEl = document.getElementById('triggerCondition' + question.questionId + '_' + fieldOrder + '_' + (sequenceIndex + 1));
                        if (triggerConditionEl && sequence.condition) {
                            triggerConditionEl.value = sequence.condition;
                        }
                        
                        const triggerTitleEl = document.getElementById('triggerTitle' + question.questionId + '_' + fieldOrder + '_' + (sequenceIndex + 1));
                        if (triggerTitleEl && sequence.title) {
                            triggerTitleEl.value = sequence.title;
                        }
                        
                        // Add trigger fields
                        if (sequence.fields && sequence.fields.length > 0) {
                            sequence.fields.forEach((triggerField, triggerFieldIndex) => {
                                // Add field based on type (label, checkbox, dropdown, date, etc.)
                                // ... field restoration logic ...
                            });
                        }
                    });
                }
            }
        }
    });
}
```

**Import Process:**
1. Iterates through `allFieldsInOrder` array
2. For dropdown fields:
   - Calls `addDropdownField()` to create the UI
   - Sets field name
   - Calls `addDropdownOption()` for each option and sets values
   - Calls `addTriggerSequence()` for each trigger sequence
   - Sets trigger condition and title
   - Adds all trigger fields

#### **4.3 Autosave Integration**
**Location**: `FormWiz GUI/gui.js` - Autosave functionality

Dropdown field configurations are automatically saved:
- When user adds/removes dropdown fields
- When user adds/removes dropdown options
- When user adds/removes trigger sequences
- When user modifies field names, option text, or node IDs
- Included in autosave data structure

**Autosave includes:**
- All unified fields with their `data-type` and `data-order` attributes
- All dropdown field names, options, and trigger sequences
- Preserved across page reloads

---

### **Summary: Complete Data Flow**

1. **GUI Setup** (`gui.js`):
   - User clicks "Add Dropdown" ‚Üí `addDropdownField()` creates UI
   - User adds options ‚Üí `addDropdownOption()` creates option inputs
   - User adds trigger sequences ‚Üí `addTriggerSequence()` creates conditional fields
   - Configuration stored in unified fields container with `data-type="dropdown"`

2. **Generate.js Processing** (`generate.js`):
   - Reads unified fields from DOM
   - Collects dropdown field name, options, and trigger sequences
   - Stores in `allFieldsInOrder` array sorted by `order`
   - Embeds `unifiedFieldsMap` as JavaScript variable in HTML

3. **Output.html Runtime** (`output.html`):
   - User selects number from numbered dropdown ‚Üí `showTextboxLabels()` called
   - Creates entry containers for each entry (1 to count)
   - For each entry, renders dropdown field with all options
   - Sets up trigger sequence handlers
   - When user selects dropdown option:
     - Shows/hides trigger sequence fields based on condition
     - Calls `dropdownMirror()` to create hidden checkbox
     - Updates hidden logic if configured

4. **Data Persistence**:
   - Export: Unified fields ‚Üí JSON `allFieldsInOrder` array
   - Import: JSON `allFieldsInOrder` ‚Üí Unified fields UI restoration
   - Autosave: Includes all unified fields in autosave data

---

### **Key Technical Details**

**Field Ordering:**
- Fields are ordered by `data-order` attribute (set when created)
- Order is preserved in `allFieldsInOrder` array
- Fields appear in the same order in each entry container

**Dropdown ID Sanitization:**
- Field name: "Is this car a Toyota?"
- Sanitized: `is_this_car_a_toyota`
- Entry 1: `is_this_car_a_toyota_1`
- Entry 2: `is_this_car_a_toyota_2`
- Uses lowercase, removes question marks, replaces non-word chars with underscores

**Trigger Sequence Logic:**
- Only one trigger sequence active per dropdown selection
- When dropdown value changes, old sequence hidden, new one shown
- Fields in hidden sequences are reset to prevent stale data
- Each entry has independent trigger sequence state

**Integration with Other Features:**
- **Hidden Dropdown Checkboxes**: Dropdown selections create hidden checkboxes via `dropdownMirror()`
- **Conditional Logic**: Dropdown fields can have conditional logic (show/hide based on checkbox states)
- **Linked Fields**: Dropdown fields can be linked to other fields
- **Hidden Logic**: Dropdown fields can trigger custom hidden logic

**Event Handling:**
- Dropdown change events trigger:
  - Trigger sequence show/hide
  - Hidden checkbox creation (`dropdownMirror`)
  - Hidden logic updates (`updateHiddenLogic`)
  - Linked field updates (`updateLinkedFields`)

---

### **Future Enhancement Opportunities**

1. **Multi-Select Dropdowns**: Allow selecting multiple options simultaneously
2. **Dropdown Validation**: Add required field validation for dropdowns
3. **Dynamic Options**: Load dropdown options from external API
4. **Option Grouping**: Group related options in dropdown (optgroup)
5. **Searchable Dropdowns**: Add search functionality to large option lists
6. **Custom Styling**: Allow custom CSS for dropdown fields
7. **Dependent Dropdowns**: Chain dropdowns where one dropdown's options depend on another's selection
8. **Dropdown Templates**: Save and reuse common dropdown configurations

---

## üõ† **Technical Implementation Details**

### **1. Dynamic Solutions**
- **Principle**: No hardcoded values, all solutions work with any question names
- **Implementation**: Uses `questionNameIds` mapping for dynamic resolution
- **Example**: Business type conditional logic uses `questionNameIds['11']` instead of hardcoded names

### **2. Event Handling**
- **Principle**: Robust event handling with proper cleanup
- **Implementation**: Event listener management with duplicate prevention
- **Example**: `window.flowchartKeyboardInitialized` flag prevents duplicate keyboard handlers

### **3. DOM Management**
- **Principle**: Proper DOM hierarchy and element positioning
- **Implementation**: Custom dropdown structures with absolute positioning
- **Example**: Search results positioned correctly using `position: relative` containers

### **4. Error Handling**
- **Principle**: Graceful error handling with user feedback
- **Implementation**: Try-catch blocks with meaningful error messages
- **Example**: Firebase operations with user-friendly error alerts

---

## üìù **Development Guidelines**

### **1. Code Organization**
- **`graph.js`**: Core graph functionality and node management
- **`library.js`**: Data persistence and Firebase integration
- **`generate.js`**: Form generation and conditional logic
- **`script.js`**: General utilities and autosave
- **`events.js`**: Event handling and user interactions
- **`context-menus.js`**: Context menu functionality

### **2. Naming Conventions**
- **Functions**: camelCase with descriptive names
- **Variables**: camelCase with clear purpose
- **Constants**: UPPER_CASE for configuration values
- **CSS Classes**: kebab-case for styling

### **3. Debugging**
- **Console Logs**: Structured logging with prefixes (e.g., `üîç [COUNTY QUESTION DEBUG]`)
- **Error Handling**: Comprehensive error catching and reporting
- **User Feedback**: Clear success/error messages for all operations

---

## üéØ **Future Enhancement Opportunities**

### **1. Performance Optimizations**
- Lazy loading for large flowcharts
- Virtual scrolling for long node lists
- Debounced autosave to reduce server load

### **2. User Experience**
- Undo/redo functionality
- Keyboard shortcuts for common actions
- Drag-and-drop reordering of nodes

### **3. Advanced Features**
- Collaborative editing
- Version control for flowcharts
- Template marketplace
- Advanced conditional logic builder

---

*Last Updated: [Current Date]*
*Version: 1.0*
*Maintainer: Development Team*

